{% extends "base.html" %}

{% block title %}Learning Goals Clustering - Learning Goals Extractor{% endblock %}

{% block extra_css %}
<style>
    .clustering-controls {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
    }
    .cluster-section {
        margin-bottom: 25px;
        border-bottom: 1px solid #e0e0e0;
        padding-bottom: 15px;
    }
    .cluster-section:last-child {
        border-bottom: none;
    }
    .cluster-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #0066cc;
        margin-bottom: 8px;
    }
    .cluster-representative {
        font-size: 0.9em;
        color: #666;
        font-style: italic;
        margin-bottom: 10px;
    }
    .goal-item {
        padding: 6px 10px;
        margin: 3px 0;
        background-color: #f8f9fa;
        border-left: 3px solid #007bff;
        border-radius: 3px;
    }
    .goal-text {
        font-size: 0.9em;
        line-height: 1.3;
        margin-bottom: 2px;
    }
    .goal-source {
        font-size: 0.75em;
        color: #6c757d;
        font-style: italic;
        line-height: 1.2;
    }
    .clustering-stats {
        background-color: #e9f5ff;
        border: 1px solid #c8e1ff;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .loading-spinner {
        text-align: center;
        padding: 40px 0;
    }

    .stem-badge {
        background: linear-gradient(45deg, #28a745, #20c997);
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.7em;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h2 class="card-title h4 mb-0">
                    <i class="bi bi-diagram-3"></i> STEM Learning Goals Clustering Sandbox
                    <span class="stem-badge">STEM-Optimized</span>
                </h2>
                <small>Discover patterns and group similar learning objectives using AI semantic analysis</small>
            </div>
            <div class="card-body">
                
                <!-- Learning Goals Overview -->
                <div id="goals-overview" class="alert alert-info mb-4">
                    <h5>‚ÑπÔ∏è Learning Goals Overview</h5>
                    <div id="overview-loading">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <span class="ms-2">Loading learning goals from database...</span>
                    </div>
                    <div id="overview-content" style="display: none;">
                        <!-- Overview content will be populated here -->
                    </div>
                </div>
                
                <!-- Clustering Controls -->
                <div class="clustering-controls border border-2 border-primary">
                    <h4 class="text-primary mb-3">üéØ Hierarchical Clustering Configuration</h4>
                    <p class="text-muted mb-3">Create many small clusters to group highly similar learning goals together for precise analysis.</p>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="n-clusters-input" class="form-label"><strong>Number of Clusters:</strong></label>
                                <div class="input-group" style="max-width: 250px;">
                                    <input type="number" class="form-control form-control-lg text-center" id="n-clusters-input" min="2" max="1000" value="50">
                                    <span class="input-group-text">clusters</span>
                                </div>
                                <div class="form-text">
                                    Create many small, specific clusters to group highly similar goals<br>
                                    <strong>Tip:</strong> Use ~20% of your total goals (e.g., 50 clusters for 250 goals)
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="d-grid gap-2">
                                <button id="cluster-btn" class="btn btn-primary btn-lg" disabled>
                                    üß† Analyze Learning Goals
                                </button>
                                <small class="text-muted">
                                    This will analyze all learning goals from uploaded documents using 
                                    <strong>all-mpnet-base-v2</strong> embeddings with STEM context optimization
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Loading Spinner -->
                <div id="loading-spinner" class="loading-spinner" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Analyzing learning goals with AI...</p>
                    <small class="text-muted">Generating semantic embeddings and clustering...</small>
                </div>

                <!-- Clustering Results -->
                <div id="results-section" style="display: none;">
                    <!-- Stats Section -->
                    <div id="clustering-stats" class="clustering-stats">
                        <!-- Stats will be populated here -->
                    </div>
                    
                    <!-- Clusters Container -->
                    <div id="clusters-container">
                        <!-- Clusters will be populated here -->
                    </div>
                </div>

                <!-- No Results -->
                <div id="no-goals" class="text-center" style="display: none;">
                    <i class="bi bi-emoji-frown" style="font-size: 3rem; color: #6c757d;"></i>
                    <h3 class="mt-3">No Learning Goals Found</h3>
                    <p class="text-muted">Please <a href="{{ url_for('main.index') }}">upload some documents</a> first to analyze learning goals.</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Load overview on page load
    loadGoalsOverview();
    
    // Input validation for number field (on blur to avoid interfering with typing)
    $('#n-clusters-input').on('blur', function() {
        var value = parseInt($(this).val());
        var maxValue = parseInt($(this).attr('max')) || 1000;
        if (isNaN(value) || value < 2) $(this).val(2);
        if (value > maxValue) $(this).val(maxValue);
    });
    
    // Clustering button
    $('#cluster-btn').click(function() {
        performClustering();
    });
    
    function loadGoalsOverview() {
        $.ajax({
            url: '{{ url_for("main.api_goals_overview") }}',
            type: 'GET',
            success: function(response) {
                if (response.success) {
                    const overviewHtml = `
                        <div class="row">
                            <div class="col-md-3">
                                <strong>Total Learning Goals:</strong> <span class="badge bg-primary">${response.total_goals}</span>
                            </div>
                            <div class="col-md-3">
                                <strong>From Documents:</strong> <span class="badge bg-secondary">${response.total_documents}</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Unique Goals:</strong> <span class="badge bg-info">${response.unique_goals}</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Avg Goals/Doc:</strong> <span class="badge bg-success">${response.avg_goals_per_doc}</span>
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                üí° Ready to cluster! Choose your parameters below and click "Analyze Learning Goals".
                            </small>
                        </div>
                    `;
                    $('#overview-content').html(overviewHtml);
                    $('#overview-loading').hide();
                    $('#overview-content').show();
                    
                    // Enable clustering if we have enough goals
                    if (response.total_goals >= 2) {
                        $('#cluster-btn').prop('disabled', false);
                        // Set max clusters to total number of goals (each goal could be its own cluster)
                        const maxClusters = response.total_goals;
                        $('#n-clusters-input').attr('max', maxClusters);
                        
                        // Set a reasonable default: ~20% of total goals for fine-grained clustering
                        const suggestedClusters = Math.max(2, Math.min(Math.floor(response.total_goals * 0.2), 100));
                        $('#n-clusters-input').val(suggestedClusters);
                        
                        // Update the help text with specific recommendation
                        $('.form-text').html(`
                            Create many small, specific clusters to group highly similar goals<br>
                            <strong>Recommended for ${response.total_goals} goals:</strong> ${suggestedClusters} clusters 
                            (Range: 2-${maxClusters})
                        `);
                    } else {
                        $('#goals-overview').removeClass('alert-info').addClass('alert-warning');
                        $('#overview-content').html(`
                            <p class="mb-0">
                                ‚ö†Ô∏è Not enough learning goals for clustering (found ${response.total_goals}, need at least 2).
                                Please <a href="{{ url_for('main.index') }}">upload more documents</a> first.
                            </p>
                        `);
                        $('#overview-loading').hide();
                        $('#overview-content').show();
                    }
                } else {
                    $('#overview-content').html(`
                        <p class="mb-0 text-danger">
                            ‚ùå Error loading learning goals: ${response.message}
                        </p>
                    `);
                    $('#overview-loading').hide();
                    $('#overview-content').show();
                    $('#goals-overview').removeClass('alert-info').addClass('alert-danger');
                }
            },
            error: function(xhr, status, error) {
                console.error('Failed to load overview:', error);
                $('#overview-content').html(`
                    <p class="mb-0 text-danger">
                        ‚ùå Failed to load learning goals overview. Please refresh the page.
                    </p>
                `);
                $('#overview-loading').hide();
                $('#overview-content').show();
                $('#goals-overview').removeClass('alert-info').addClass('alert-danger');
            }
        });
    }
    
    function performClustering() {
        const nClusters = $('#n-clusters-input').val();
        
        // Show loading
        $('#loading-spinner').show();
        $('#results-section').hide();
        $('#no-goals').hide();
        $('#cluster-btn').prop('disabled', true);
        
        // API call
        $.ajax({
            url: '{{ url_for("main.api_cluster_goals") }}',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                n_clusters: parseInt(nClusters)
            }),
            success: function(response) {
                if (response.success) {
                    displayResults(response);
                } else {
                    if (response.message.includes('Need at least')) {
                        $('#no-goals').show();
                    } else {
                        alert('Error: ' + response.message);
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error('Clustering failed:', error);
                alert('Failed to perform clustering. Please try again.\nError: ' + error);
            },
            complete: function() {
                $('#loading-spinner').hide();
                $('#cluster-btn').prop('disabled', false);
            }
        });
    }
    
    function displayResults(data) {
        // Display stats
        const qualityLabel = getQualityLabel(data.silhouette_score);
        const statsHtml = `
            <h5><i class="bi bi-graph-up"></i> Clustering Results</h5>
            <div class="row">
                <div class="col-md-3">
                    <strong>Total Learning Goals:</strong> ${data.total_goals}
                </div>
                <div class="col-md-2">
                    <strong>Clusters Found:</strong> ${data.n_clusters}
                </div>
                <div class="col-md-3">
                    <strong>Method Used:</strong> ${data.method_used}
                </div>
                <div class="col-md-4">
                    <strong>Quality Score:</strong> ${data.silhouette_score} 
                    <span class="badge ${qualityLabel.class}">${qualityLabel.text}</span>
                </div>
            </div>
        `;
        $('#clustering-stats').html(statsHtml);
        
        // Sort clusters by ID to ensure chronological order (outliers at the end)
        const sortedClusters = data.clusters.slice().sort(function(a, b) {
            const aIsOutlier = String(a.id).startsWith('outlier');
            const bIsOutlier = String(b.id).startsWith('outlier');
            
            // Put outliers at the end
            if (aIsOutlier && !bIsOutlier) return 1;
            if (!aIsOutlier && bIsOutlier) return -1;
            if (aIsOutlier && bIsOutlier) return 0;
            
            // Sort regular clusters by ID
            return parseInt(a.id) - parseInt(b.id);
        });
        
        // Display clusters
        let clustersHtml = '';
        sortedClusters.forEach(function(cluster, index) {
            const clusterColor = getClusterColor(parseInt(cluster.id) || index);
            const isOutlier = String(cluster.id).startsWith('outlier');
            // Display 1-based indexing for UI (cluster.id is 0-based from backend)
            const displayClusterId = isOutlier ? cluster.id : (parseInt(cluster.id) + 1);
            const clusterTitle = isOutlier ? `Outlier ${cluster.id}` : `Cluster ${displayClusterId}`;
            
            clustersHtml += `
                <div class="cluster-section">
                    <div class="cluster-title">
                        ${clusterTitle} 
                        <span class="badge bg-primary text-white ms-2">${cluster.size}</span>
                        ${isOutlier ? ' ‚ö†Ô∏è' : ''}
                    </div>
                    <div class="cluster-representative">
                        Representative: "${truncateText(cluster.representative_goal, 100)}"
                    </div>
                    <div class="row">
            `;
            
            cluster.goals.forEach(function(goal, goalIndex) {
                const source = cluster.sources[goalIndex];
                clustersHtml += `
                    <div class="col-md-6 mb-2">
                        <div class="goal-item">
                            <div class="goal-text">"${goal}"</div>
                            <div class="goal-source">
                                üìÑ ${truncateText(source.document_name, 25)} | 
                                üë§ ${truncateText(source.creator, 15)}
                                ${source.course_name ? ` | üìö ${truncateText(source.course_name, 20)}` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            clustersHtml += `
                    </div>
                </div>
            `;
        });
        
        $('#clusters-container').html(clustersHtml);
        $('#results-section').show();
    }
    
    function getClusterColor(index) {
        const colors = [
            'linear-gradient(45deg, #007bff, #0056b3)',
            'linear-gradient(45deg, #28a745, #1e7e34)',
            'linear-gradient(45deg, #dc3545, #bd2130)',
            'linear-gradient(45deg, #ffc107, #d39e00)',
            'linear-gradient(45deg, #17a2b8, #117a8b)',
            'linear-gradient(45deg, #6f42c1, #5a32a3)',
            'linear-gradient(45deg, #fd7e14, #d35400)',
            'linear-gradient(45deg, #20c997, #16a085)',
            'linear-gradient(45deg, #e83e8c, #d91a72)',
            'linear-gradient(45deg, #6c757d, #5a6268)'
        ];
        return colors[index % colors.length];
    }
    
    function getQualityLabel(score) {
        if (score >= 0.7) return {class: 'bg-success', text: 'Excellent'};
        if (score >= 0.5) return {class: 'bg-info', text: 'Good'};
        if (score >= 0.3) return {class: 'bg-warning', text: 'Fair'};
        if (score >= 0.1) return {class: 'bg-warning', text: 'Poor'};
        return {class: 'bg-secondary', text: 'N/A'};
    }
    
    function truncateText(text, maxLength) {
        if (text.length <= maxLength) return text;
        return text.substring(0, maxLength) + '...';
    }
});
</script>
{% endblock %} 