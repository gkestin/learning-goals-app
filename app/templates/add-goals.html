{% extends "base.html" %}

{% block title %}Add Learning Goals - Learning Goals Extractor{% endblock %}

{% block extra_css %}
<style>
    .hierarchical-selector {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        max-height: 400px;
        overflow-y: auto;
    }
    
    .creator-item, .course-item, .document-item {
        margin-bottom: 8px;
        padding: 8px 12px;
        border-radius: 4px;
        background-color: white;
        border: 1px solid #e9ecef;
    }
    
    .creator-item {
        border-left: 4px solid #007bff;
    }
    
    .course-item {
        border-left: 4px solid #ffc107;
        margin-left: 20px;
    }
    
    .document-item {
        border-left: 4px solid #6c757d;
        margin-left: 40px;
    }
    
    .expand-icon {
        transition: transform 0.3s ease;
        cursor: pointer;
        margin-right: 8px;
    }
    
    .expanded .expand-icon {
        transform: rotate(90deg);
    }
    
    .children {
        margin-top: 8px;
        display: none;
    }
    
    .expanded .children {
        display: block;
    }
    
    .selection-summary {
        background-color: #e3f2fd;
        border: 1px solid #90caf9;
        border-radius: 4px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .prompt-section {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .copy-section {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .progress-section {
        display: none;
        background-color: #e8f5e8;
        border: 1px solid #c8e6c9;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .confirmation-section {
        display: none;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .results-preview {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        padding: 15px;
        background-color: white;
        margin: 15px 0;
    }
    
    .document-result {
        margin-bottom: 20px;
        padding: 15px;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        background-color: #fafafa;
    }
    
    .document-result h6 {
        color: #495057;
        margin-bottom: 10px;
    }
    
    .goals-list {
        list-style-type: none;
        padding-left: 0;
    }
    
    .goals-list li {
        background-color: white;
        margin: 5px 0;
        padding: 8px 12px;
        border-left: 3px solid #007bff;
        border-radius: 0 4px 4px 0;
        font-size: 0.9rem;
    }
    
    .sample-warning {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 4px;
        padding: 10px;
        margin-bottom: 15px;
    }
    
    .processing-files {
        background-color: #e3f2fd;
        border: 1px solid #90caf9;
        border-radius: 4px;
        padding: 10px;
        margin-bottom: 15px;
        max-height: 200px;
        overflow-y: auto;
        transition: all 0.3s ease;
    }
    
    .single-file-processing {
        background-color: #f0f8ff;
        border: 2px solid #4285f4;
        padding: 15px;
        box-shadow: 0 2px 8px rgba(66, 133, 244, 0.15);
    }
    
    .single-file-processing .file-processing-item {
        font-size: 1rem;
        padding: 8px 0;
        font-weight: 500;
    }
    
    .file-processing-item {
        display: flex;
        align-items: center;
        padding: 4px 0;
        font-size: 0.9rem;
    }
    
    .file-processing-item .status-icon {
        margin-right: 8px;
        width: 16px;
        text-align: center;
    }
    
    .file-status-pending { color: #6c757d; }
    .file-status-processing { color: #007bff; }
    .file-status-complete { color: #28a745; }
    .file-status-error { color: #dc3545; }
    
    /* Spinning animation for processing icons */
    .spin {
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    /* Processing indicator animations */
    .processing-indicator {
        margin-left: 8px;
        color: #007bff;
        font-weight: bold;
    }
    
    .processing-indicator i {
        animation: pulse 1.5s ease-in-out infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 0.3; }
        50% { opacity: 1; }
    }
    
    /* Enhanced progress bar for single documents */
    .progress-bar-enhanced {
        background: linear-gradient(-45deg, #007bff, #0056b3, #007bff, #0056b3);
        background-size: 400% 400%;
        animation: gradientShift 2s ease infinite;
    }
    
    @keyframes gradientShift {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }
    
    .document-count {
        font-size: 0.875rem;
        color: #6c757d;
        font-weight: normal;
    }
    
    .checkbox-label {
        display: flex;
        align-items: center;
        cursor: pointer;
    }
    
    .checkbox-label input[type="checkbox"] {
        margin-right: 8px;
    }
    
    .item-info {
        flex-grow: 1;
    }
    
    .custom-prompt-toggle {
        margin-bottom: 15px;
    }
    
    .saved-prompts {
        margin-bottom: 15px;
    }
    
    .form-check.text-muted {
        opacity: 0.6;
    }
    
    .form-check.text-muted .form-check-input:disabled {
        opacity: 0.5;
    }
    
    .border-warning {
        border-color: #ffc107 !important;
        box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25);
    }
    
    #category-title-warning {
        margin-top: 0.5rem;
        padding: 0.5rem;
        background-color: #fff3cd;
        border: 1px solid #ffecb5;
        border-radius: 0.25rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h2 class="card-title h4 mb-0">
                        <i class="bi bi-plus-circle"></i> Add Learning Goals with Custom Prompts
                    </h2>
                    <small>Extract additional learning goals using custom prompts and organize them by category</small>
                </div>
                <div class="card-body">
                    


                    <!-- Document Selection Section -->
                    <div class="mb-4">
                        <h5 class="mb-3">
                            <i class="bi bi-check2-square"></i> Select Documents
                        </h5>
                        
                        <div class="mb-3">
                            <button type="button" class="btn btn-sm btn-outline-primary me-2" id="select-all-btn">
                                <i class="bi bi-check-square"></i> Select All
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary me-2" id="clear-all-btn">
                                <i class="bi bi-square"></i> Clear All
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-info" id="refresh-documents-btn">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                        </div>
                        
                        <div id="selection-summary" class="selection-summary" style="display: none;">
                            <strong>Selected:</strong> <span id="selected-count">0</span> documents
                        </div>
                        
                        <div id="document-selector" class="hierarchical-selector">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading documents...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Custom Prompt Section -->
                    <div class="prompt-section">
                        <h5 class="mb-3">
                            <i class="bi bi-chat-square-text"></i> Custom Prompt Configuration
                        </h5>
                        
                        <!-- Saved Prompts -->
                        <div class="saved-prompts">
                            <label for="saved-prompt-select" class="form-label">Use Saved Prompt (Optional):</label>
                            <select id="saved-prompt-select" class="form-select">
                                <option value="">Create new prompt</option>
                            </select>
                        </div>
                        
                        <!-- Category Title -->
                        <div class="mb-3">
                            <label for="category-title" class="form-label">Category Title *</label>
                            <input type="text" id="category-title" class="form-control" placeholder="e.g., 'Graphing Skills', 'Basic Concepts', 'Advanced Topics'" required>
                            <div class="form-text">This will be the heading under which these learning goals are organized.</div>
                            <div id="category-title-warning" class="form-text text-warning" style="display: none;">
                                <i class="bi bi-exclamation-triangle"></i>
                                <strong>Name Conflict:</strong> <span id="conflict-message"></span>
                            </div>
                        </div>
                        
                        <!-- System Prompt -->
                        <div class="mb-3">
                            <label for="system-prompt" class="form-label">System Message *</label>
                            <textarea id="system-prompt" class="form-control" rows="6" placeholder="Enter your custom AI instructions..." required></textarea>
                            <div class="form-text">
                                Provide specific instructions for what types of learning goals to extract. 
                                Include instructions for what to return if no relevant goals are found.
                            </div>
                        </div>
                        
                        <!-- User Prompt -->
                        <div class="mb-3">
                            <label for="user-prompt" class="form-label">User Message</label>
                            <input type="text" id="user-prompt" class="form-control" value="Extract learning goals from the following text:" placeholder="Extract learning goals from the following text:">
                            <div class="form-text">
                                The message sent to the AI before the document content.
                                <span class="float-end">
                                    <small>Model:</small>
                                    <select class="form-select form-select-sm d-inline-block" id="model" name="model" style="width: auto; min-width: 120px;">
                                        <option value="gpt-4o" selected>GPT-4o</option>
                                        <option value="gpt-4.1">GPT-4.1</option>
                                    </select>
                                </span>
                            </div>
                        </div>
                        
                        <!-- Save Prompt Option -->
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="save-prompt" checked>
                                <label class="form-check-label" for="save-prompt">
                                    Save this prompt for future reuse
                                </label>
                                <div class="form-text">
                                    <small class="text-muted" id="save-prompt-help">This will save your custom prompt settings for quick reuse in future extractions.</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="text-center">
                        <button type="button" class="btn btn-success btn-lg" id="extract-btn" disabled>
                            <i class="bi bi-magic"></i> Extract Learning Goals
                        </button>
                    </div>

                    <!-- Prompt Deletion Section (Subtle/Collapsed by default) -->
                    <div class="mt-4">
                        <div class="text-center">
                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#prompt-deletion-section" aria-expanded="false" aria-controls="prompt-deletion-section">
                                <i class="bi bi-trash3"></i> Advanced: Delete Learning Goals by Prompt
                            </button>
                        </div>
                        
                        <div class="collapse mt-3" id="prompt-deletion-section">
                            <div class="card border-warning">
                                <div class="card-header bg-warning text-dark">
                                    <h6 class="mb-0">
                                        <i class="bi bi-exclamation-triangle"></i> Delete Learning Goals by Prompt
                                    </h6>
                                    <small>Remove learning goals for specific prompts from selected files. Deleted goals will be archived.</small>
                                    <div class="mt-2">
                                        <a href="/archived-prompts" target="_blank" class="btn btn-sm btn-outline-secondary">
                                            <i class="bi bi-archive"></i> View Archived Items
                                        </a>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="deletion-prompt-select" class="form-label">Select Prompt to Delete:</label>
                                            <select id="deletion-prompt-select" class="form-select">
                                                <option value="">Choose a prompt...</option>
                                            </select>
                                            <div class="form-text">
                                                <small class="text-muted">Shows all prompts used in the database (saved and non-saved)</small>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Files with this prompt:</label>
                                            <div id="prompt-files-container" class="border rounded p-2" style="max-height: 200px; overflow-y: auto; min-height: 100px;">
                                                <div class="text-muted text-center">
                                                    <small>Select a prompt to see files</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-3" id="deletion-actions" style="display: none;">
                                        <div class="row">
                                            <div class="col-md-8">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="delete-prompt-if-empty">
                                                    <label class="form-check-label" for="delete-prompt-if-empty" id="delete-prompt-checkbox-label">
                                                        Also delete the prompt itself if no files use it (or if it's unused)
                                                    </label>
                                                    <div id="delete-prompt-help" class="form-text" style="display: none;">
                                                        Select all files to enable prompt deletion
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4 text-end">
                                                <button type="button" class="btn btn-outline-primary btn-sm me-2" id="select-all-files-btn">
                                                    <i class="bi bi-check-square"></i> Select All
                                                </button>
                                                <button type="button" class="btn btn-danger" id="delete-prompt-goals-btn" disabled>
                                                    <i class="bi bi-trash3"></i> Delete Selected
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Progress Section -->
                    <div class="progress-section" id="progress-section">
                        <h5 class="mb-3">
                            <i class="bi bi-hourglass-split"></i> Extracting Learning Goals
                        </h5>
                        <div class="progress mb-3">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" id="main-progress" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div id="progress-details">
                            <div><strong>Status:</strong> <span id="progress-status">Preparing...</span></div>
                            <div><strong>Current:</strong> <span id="current-document">-</span></div>
                            <div><strong>Progress:</strong> <span id="document-progress">0 / 0</span></div>
                        </div>
                        
                        <!-- Processing Files List -->
                        <div id="processing-files-container" class="processing-files" style="display: none;">
                            <h6><i class="bi bi-list-ul"></i> Processing Files:</h6>
                            <div id="processing-files-list"></div>
                        </div>
                    </div>

                    <!-- Confirmation Section -->
                    <div class="confirmation-section" id="confirmation-section">
                        <h5 class="mb-3">
                            <i class="bi bi-check-circle"></i> Review Extracted Learning Goals
                        </h5>
                        
                        <div id="confirmation-summary" class="alert alert-info">
                            <!-- Summary will be populated here -->
                </div>
                        
                        <div id="sample-warning" class="sample-warning" style="display: none;">
                            <i class="bi bi-exclamation-triangle"></i>
                            <strong>Note:</strong> You are viewing a sample of results from a subset of files. 
                            All selected files have been processed and will be saved.
            </div>
                        
                        <div class="results-preview" id="results-preview">
                            <!-- Results will be populated here -->
                        </div>
                        
                        <div class="text-center">
                            <button type="button" class="btn btn-success btn-lg me-3" id="confirm-save-btn">
                                <i class="bi bi-check-lg"></i> Save Learning Goals
                            </button>
                            <button type="button" class="btn btn-secondary btn-lg me-3" id="go-back-btn">
                                <i class="bi bi-arrow-left"></i> Go Back & Modify
                            </button>
                            <button type="button" class="btn btn-outline-danger" id="cancel-extraction-btn">
                                <i class="bi bi-x-lg"></i> Cancel
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='lock-manager.js') }}"></script>
<script>
$(document).ready(function() {
    let documents = [];
    let selectedDocuments = new Set();
    let savedPrompts = [];
    let allPrompts = [];
    let selectedFilesForDeletion = new Set();
    
    // Load documents and saved prompts
    loadDocuments();
    loadSavedPrompts();
    loadAllPrompts();
    
    // Initialize save prompt checkbox state
    $('#save-prompt').prop('checked', true).prop('disabled', false);
    
    // Event handlers
    $('#select-all-btn').click(selectAllDocuments);
    $('#clear-all-btn').click(clearAllDocuments);
    $('#refresh-documents-btn').click(loadDocuments);

    $('#extract-btn').click(extractLearningGoals);
    $('#saved-prompt-select').change(loadSavedPrompt);
    
    // Confirmation dialog buttons
    $('#confirm-save-btn').click(confirmAndSaveResults);
    $('#go-back-btn').click(goBackToForm);
    $('#cancel-extraction-btn').click(cancelExtraction);
    
    // Prompt deletion functionality
    $('#deletion-prompt-select').change(onDeletionPromptChange);
    $('#select-all-files-btn').click(selectAllFilesForDeletion);
    $('#delete-prompt-goals-btn').click(deletePromptGoals);
    
    // Validation and prompt modification handling
    $('#category-title, #system-prompt').on('input', validateForm);
    $('#category-title, #system-prompt, #user-prompt').on('input', handlePromptModification);
    
    function loadDocuments() {
        $('#document-selector').html(`
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading documents...</p>
            </div>
        `);
        
        $.ajax({
            url: '/api/get-documents-hierarchical',
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    documents = response.documents;
                    renderHierarchicalSelector(response.hierarchy);
                } else {
                    showError('Failed to load documents: ' + response.message);
                }
            },
            error: function() {
                showError('Failed to load documents. Please try again.');
            }
        });
    }
    
    function loadSavedPrompts() {
        $.ajax({
            url: '/api/get-saved-prompts',
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    savedPrompts = response.prompts;
                    populateSavedPrompts();
                }
            },
            error: function() {
                console.log('No saved prompts available');
            }
        });
    }
    
    function populateSavedPrompts() {
        const select = $('#saved-prompt-select');
        select.find('option:not(:first)').remove();
        
        savedPrompts.forEach((prompt, index) => {
            select.append(`<option value="${index}">${prompt.title}</option>`);
        });
    }
    
    function loadSavedPrompt() {
        const index = $('#saved-prompt-select').val();
        if (index && savedPrompts[index]) {
            // Loading an existing saved prompt
            const prompt = savedPrompts[index];
            $('#category-title').val(prompt.title);
            $('#system-prompt').val(prompt.system_prompt);
            $('#user-prompt').val(prompt.user_prompt);
            
            // Disable and uncheck save prompt option since this is an existing prompt
            $('#save-prompt').prop('checked', false).prop('disabled', true);
            $('#save-prompt').closest('.form-check').addClass('text-muted');
            $('label[for="save-prompt"]').text('Using existing saved prompt');
            $('#save-prompt-help').text('You are using a previously saved prompt. Modify any field to enable saving a new version.');
            
            validateForm();
        } else {
            // Creating a new prompt or cleared selection
            $('#save-prompt').prop('disabled', false);
            $('#save-prompt').closest('.form-check').removeClass('text-muted');
            $('label[for="save-prompt"]').text('Save this prompt for future reuse');
            $('#save-prompt-help').text('This will save your custom prompt settings for quick reuse in future extractions.');
            
            // Clear any conflict warnings
            $('#category-title-warning').hide();
            $('#category-title').removeClass('border-warning');
            
            // If fields are cleared, reset save checkbox to checked
            if (!index) {
                $('#category-title').val('');
                $('#system-prompt').val('');
                $('#user-prompt').val('Extract learning goals from the following text:');
                $('#save-prompt').prop('checked', true);
            }
            
            validateForm();
        }
    }
    
    function renderHierarchicalSelector(hierarchy) {
        let html = '';
        let elementCounter = 0; // Use counter for unique IDs instead of names
        
        for (const [creator, creatorData] of Object.entries(hierarchy)) {
            const creatorId = `creator-${elementCounter++}`;
            const creatorDocCount = Object.values(creatorData.courses).reduce((sum, course) => sum + course.documents.length, 0);
            
            html += `
                <div class="creator-item" data-creator="${creator}">
                    <div class="checkbox-label">
                        <input type="checkbox" class="creator-checkbox" data-creator="${creator}">
                        <i class="bi bi-chevron-right expand-icon" onclick="toggleExpand('${creatorId}')"></i>
                        <div class="item-info">
                            <strong>${creator}</strong>
                            <span class="document-count">(${creatorDocCount} documents)</span>
                            ${creatorData.institution ? `<br><small class="text-muted">${creatorData.institution}</small>` : ''}
                        </div>
                    </div>
                    <div class="children" id="${creatorId}">
            `;
            
            for (const [courseName, courseData] of Object.entries(creatorData.courses)) {
                const courseId = `course-${elementCounter++}`;
                
                html += `
                    <div class="course-item" data-course="${courseName}" data-creator="${creator}">
                        <div class="checkbox-label">
                            <input type="checkbox" class="course-checkbox" data-creator="${creator}" data-course="${courseName}">
                            <i class="bi bi-chevron-right expand-icon" onclick="toggleExpand('${courseId}')"></i>
                            <div class="item-info">
                                <strong>${courseName}</strong>
                                <span class="document-count">(${courseData.documents.length} documents)</span>
                            </div>
                        </div>
                        <div class="children" id="${courseId}">
                `;
                
                courseData.documents.forEach(doc => {
                    html += `
                        <div class="document-item" data-document-id="${doc.id}">
                            <div class="checkbox-label">
                                <input type="checkbox" class="document-checkbox" data-document-id="${doc.id}" data-creator="${creator}" data-course="${courseName}">
                                <div class="item-info">
                                    <strong>${doc.name}</strong>
                                    <br><small class="text-muted">${doc.doc_type || 'Document'}</small>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            html += `
                    </div>
                </div>
            `;
        }
        
        if (html === '') {
            html = `
                <div class="text-center text-muted">
                    <i class="bi bi-folder-x" style="font-size: 2rem;"></i>
                    <p class="mt-2">No documents found. <a href="{{ url_for('main.index') }}">Upload some documents</a> first.</p>
                </div>
            `;
        }
        
        $('#document-selector').html(html);
        
        // Ensure all elements start collapsed
        $('.creator-item, .course-item').removeClass('expanded');
        $('.children').hide();
        
        // Set up event handlers for checkboxes
        setupCheckboxHandlers();
    }
    
    function setupCheckboxHandlers() {
        // Creator checkboxes
        $('.creator-checkbox').change(function() {
            const creator = $(this).data('creator');
            const checked = $(this).prop('checked');
            
            // Update all courses and documents for this creator
            $(`.course-checkbox[data-creator="${creator}"]`).prop('checked', checked);
            $(`.document-checkbox[data-creator="${creator}"]`).prop('checked', checked);
            
            updateSelectedDocuments();
        });
        
        // Course checkboxes
        $('.course-checkbox').change(function() {
            const creator = $(this).data('creator');
            const course = $(this).data('course');
            const checked = $(this).prop('checked');
            
            // Update all documents for this course
            $(`.document-checkbox[data-creator="${creator}"][data-course="${course}"]`).prop('checked', checked);
            
            // Update creator checkbox state
            updateCreatorCheckbox(creator);
            updateSelectedDocuments();
        });
        
        // Document checkboxes
        $('.document-checkbox').change(function() {
            const creator = $(this).data('creator');
            const course = $(this).data('course');
            
            updateCourseCheckbox(creator, course);
            updateCreatorCheckbox(creator);
            updateSelectedDocuments();
        });
    }
    
    function updateCreatorCheckbox(creator) {
        const allCourseCheckboxes = $(`.course-checkbox[data-creator="${creator}"]`);
        const checkedCourseCheckboxes = $(`.course-checkbox[data-creator="${creator}"]:checked`);
        const creatorCheckbox = $(`.creator-checkbox[data-creator="${creator}"]`);
        
        if (checkedCourseCheckboxes.length === 0) {
            creatorCheckbox.prop('checked', false);
        } else if (checkedCourseCheckboxes.length === allCourseCheckboxes.length) {
            creatorCheckbox.prop('checked', true);
        } else {
            creatorCheckbox.prop('indeterminate', true);
        }
    }
    
    function updateCourseCheckbox(creator, course) {
        const allDocCheckboxes = $(`.document-checkbox[data-creator="${creator}"][data-course="${course}"]`);
        const checkedDocCheckboxes = $(`.document-checkbox[data-creator="${creator}"][data-course="${course}"]:checked`);
        const courseCheckbox = $(`.course-checkbox[data-creator="${creator}"][data-course="${course}"]`);
        
        if (checkedDocCheckboxes.length === 0) {
            courseCheckbox.prop('checked', false);
        } else if (checkedDocCheckboxes.length === allDocCheckboxes.length) {
            courseCheckbox.prop('checked', true);
        } else {
            courseCheckbox.prop('indeterminate', true);
        }
    }
    
    function updateSelectedDocuments() {
        selectedDocuments.clear();
        $('.document-checkbox:checked').each(function() {
            selectedDocuments.add($(this).data('document-id'));
        });
        
        $('#selected-count').text(selectedDocuments.size);
        if (selectedDocuments.size > 0) {
            $('#selection-summary').show();
        } else {
            $('#selection-summary').hide();
        }
        
        validateForm();
    }
    
    function selectAllDocuments() {
        $('.creator-checkbox, .course-checkbox, .document-checkbox').prop('checked', true);
        updateSelectedDocuments();
    }
    
    function clearAllDocuments() {
        $('.creator-checkbox, .course-checkbox, .document-checkbox').prop('checked', false);
        updateSelectedDocuments();
    }
    
    function toggleExpand(elementId) {
        const $children = $(`#${elementId}`);
        const $parent = $children.parent(); // Get the direct parent (creator-item or course-item)
        const $icon = $parent.find('.expand-icon').first();
        
        if ($parent.hasClass('expanded')) {
            // Currently expanded, so collapse
            $parent.removeClass('expanded');
            $children.slideUp(200);
        } else {
            // Currently collapsed, so expand
            $parent.addClass('expanded');
            $children.slideDown(200);
        }
    }
    
    function validateForm() {
        const hasSelection = selectedDocuments.size > 0;
        const hasTitle = $('#category-title').val().trim().length > 0;
        const hasSystemPrompt = $('#system-prompt').val().trim().length > 0;
        
        $('#extract-btn').prop('disabled', !(hasSelection && hasTitle && hasSystemPrompt));
    }
    
    function handlePromptModification() {
        const selectedIndex = $('#saved-prompt-select').val();
        const currentTitle = $('#category-title').val().trim();
        
        if (selectedIndex && savedPrompts[selectedIndex]) {
            const originalPrompt = savedPrompts[selectedIndex];
            const currentSystem = $('#system-prompt').val().trim();
            const currentUser = $('#user-prompt').val().trim();
            
            // Check if any field has been modified from the original
            const isModified = currentTitle !== originalPrompt.title || 
                             currentSystem !== originalPrompt.system_prompt || 
                             currentUser !== originalPrompt.user_prompt;
            
            if (isModified) {
                // User has modified the saved prompt, so re-enable save option
                $('#save-prompt').prop('disabled', false).prop('checked', true);
                $('#save-prompt').closest('.form-check').removeClass('text-muted');
                $('label[for="save-prompt"]').text('Save this modified prompt for future reuse');
                
                // Check for potential overwrite conflicts
                checkForPromptNameConflict(currentTitle, selectedIndex);
            } else {
                // Back to original saved prompt, disable save again
                $('#save-prompt').prop('checked', false).prop('disabled', true);
                $('#save-prompt').closest('.form-check').addClass('text-muted');
                $('label[for="save-prompt"]').text('Using existing saved prompt');
                $('#save-prompt-help').text('You are using a previously saved prompt. Modify any field to enable saving a new version.');
                
                // Clear any conflict warnings since we're back to original
                $('#category-title-warning').hide();
                $('#category-title').removeClass('border-warning');
            }
        } else {
            // No saved prompt selected, this is a new custom prompt
            $('#save-prompt').prop('disabled', false);
            $('#save-prompt').closest('.form-check').removeClass('text-muted');
            $('label[for="save-prompt"]').text('Save this prompt for future reuse');
            
            // Check for potential overwrite conflicts
            checkForPromptNameConflict(currentTitle, null);
        }
    }
    
    function checkForPromptNameConflict(currentTitle, excludeIndex) {
        if (!currentTitle) {
            $('#save-prompt-help').text('This will save your custom prompt settings for quick reuse in future extractions.');
            $('#category-title-warning').hide();
            $('#category-title').removeClass('border-warning');
            return;
        }
        
        // Check if title conflicts with any existing saved prompt (excluding the current one being modified)
        const conflictingPrompt = savedPrompts.find((prompt, index) => 
            prompt.title.toLowerCase() === currentTitle.toLowerCase() && 
            index != excludeIndex
        );
        
        if (conflictingPrompt) {
            // There's a name conflict
            $('#save-prompt-help').html(`
                <span class="text-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Warning:</strong> A prompt named "${currentTitle}" already exists. 
                    Saving will overwrite the existing prompt.
                </span>
            `);
            
            // Show warning in category title field
            $('#conflict-message').text(`This will overwrite the existing "${currentTitle}" prompt. Change the name to create a new prompt instead.`);
            $('#category-title-warning').show();
            $('#category-title').addClass('border-warning');
        } else {
            // No conflict
            $('#category-title-warning').hide();
            $('#category-title').removeClass('border-warning');
            
            if (excludeIndex !== null) {
                $('#save-prompt-help').text('You have modified the saved prompt. This will save the modified version as a new prompt.');
            } else {
                $('#save-prompt-help').text('This will save your custom prompt settings for quick reuse in future extractions.');
            }
        }
    }
    

    
    let extractionResults = null; // Store extraction results for confirmation
    let eventSource = null; // Store event source for cleanup
    
    function extractLearningGoals() {
        const categoryTitle = $('#category-title').val().trim();
        const systemPrompt = $('#system-prompt').val().trim();
        const userPrompt = $('#user-prompt').val().trim();
        const selectedModel = $('#model').val();
        const savePrompt = $('#save-prompt').prop('checked');
        
        if (!categoryTitle || !systemPrompt) {
            showError('Please fill in all required fields.');
            return;
        }
        
        if (selectedDocuments.size === 0) {
            showError('Please select at least one document.');
            return;
        }
        
        // Reset previous results
        extractionResults = null;
        
        // Show progress section and hide confirmation
        $('#progress-section').show();
        $('#confirmation-section').hide();
        $('#extract-btn').prop('disabled', true);
        
        // Reset progress
        $('#main-progress').css('width', '0%').removeClass('progress-bar-enhanced bg-danger');
        $('#progress-status').text('Preparing...');
        $('#current-document').text('-');
        $('#document-progress').text('0 / 0');
        
        // Initialize processing files list
        initializeProcessingFilesList();
        
        // Start extraction with streaming
        const extractionData = {
            document_ids: Array.from(selectedDocuments),
            category_title: categoryTitle,
            system_prompt: systemPrompt,
            user_prompt: userPrompt,
            model: selectedModel,
            save_prompt: savePrompt
        };
        
        // Start streaming extraction using fetch with streaming response
        fetch('/api/extract-bulk-learning-goals-stream', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(extractionData)
        }).then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            
            function readStream() {
                return reader.read().then(({ done, value }) => {
                    if (done) {
                        return;
                    }
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                handleExtractionProgress(data);
                            } catch (e) {
                                console.error('Error parsing stream data:', e);
                            }
                        }
                    }
                    
                    return readStream();
                });
            }
            
            return readStream();
            
        }).catch(error => {
            console.error('Error during extraction:', error);
                showError('Extraction failed. Please try again.');
                $('#extract-btn').prop('disabled', false);
        });
    }
    
    function initializeProcessingFilesList() {
        const filesList = $('#processing-files-list');
        filesList.empty();
        
        // Get selected document names from the DOM
        const selectedDocs = [];
        $('.document-checkbox:checked').each(function() {
            const docId = $(this).data('document-id');
            const docName = $(this).closest('.document-item').find('.item-info strong').text();
            selectedDocs.push({ id: docId, name: docName });
        });
        
        // Update container title based on number of files
        const containerTitle = selectedDocs.length === 1 ? 
            '<h6><i class="bi bi-file-earmark-text"></i> Processing File:</h6>' : 
            `<h6><i class="bi bi-list-ul"></i> Processing ${selectedDocs.length} Files:</h6>`;
        $('#processing-files-container h6').html(containerTitle);
        
        selectedDocs.forEach((doc, index) => {
            const item = $(`
                <div class="file-processing-item" data-doc-id="${doc.id}" data-doc-index="${index}">
                    <span class="status-icon file-status-pending">
                        <i class="bi bi-circle"></i>
                    </span>
                    <span class="file-name">${doc.name}</span>
                    <span class="processing-indicator" style="display: none;">
                        <i class="bi bi-three-dots"></i>
                    </span>
                </div>
            `);
            filesList.append(item);
        });
        
        $('#processing-files-container').show();
        
        // For single documents, make the processing more prominent
        if (selectedDocs.length === 1) {
            $('#processing-files-container').addClass('single-file-processing');
        }
    }
    
    function updateFileStatus(docIndex, status, docName) {
        // Find by index first, then by name as fallback
        let item = $(`.file-processing-item[data-doc-index="${docIndex}"]`);
        
        if (item.length === 0 && docName) {
            // Try to find by name as fallback
            item = $(`.file-processing-item .file-name:contains("${docName}")`).closest('.file-processing-item');
        }
        
        if (item.length === 0 && docName) {
            // Add new item if not found (fallback)
            const newItem = $(`
                <div class="file-processing-item" data-doc-index="${docIndex}">
                    <span class="status-icon file-status-pending">
                        <i class="bi bi-circle"></i>
                    </span>
                    <span class="file-name">${docName}</span>
                    <span class="processing-indicator" style="display: none;">
                        <i class="bi bi-three-dots"></i>
                    </span>
                </div>
            `);
            $('#processing-files-list').append(newItem);
            item = newItem;
        }
        
        const statusIcon = item.find('.status-icon');
        const processingIndicator = item.find('.processing-indicator');
        statusIcon.removeClass('file-status-pending file-status-processing file-status-complete file-status-error');
        
        switch (status) {
            case 'processing':
                statusIcon.addClass('file-status-processing').html('<i class="bi bi-arrow-clockwise spin"></i>');
                processingIndicator.show();
                break;
            case 'complete':
                statusIcon.addClass('file-status-complete').html('<i class="bi bi-check-circle-fill"></i>');
                processingIndicator.hide();
                break;
            case 'error':
                statusIcon.addClass('file-status-error').html('<i class="bi bi-x-circle-fill"></i>');
                processingIndicator.hide();
                break;
            default:
                statusIcon.addClass('file-status-pending').html('<i class="bi bi-circle"></i>');
                processingIndicator.hide();
        }
    }
    
    function handleExtractionProgress(data) {
        switch (data.status) {
            case 'starting':
                $('#progress-status').text(data.message);
                $('#document-progress').text(`0 / ${data.total_documents || 0}`);
                // Start with a small progress to show activity
                $('#main-progress').css('width', '5%').addClass('progress-bar-animated');
                
                // Add enhanced animation for single documents
                if (data.total_documents === 1) {
                    $('#main-progress').addClass('progress-bar-enhanced');
                }
                break;
                
            case 'prompt_saved':
                $('#progress-status').text(data.message);
                $('#main-progress').css('width', '10%');
                break;
                
            case 'processing':
                $('#progress-status').text(data.message);
                if (data.current_document) {
                    $('#current-document').text(data.current_document);
                    updateFileStatus(data.current_index, 'processing', data.current_document);
                }
                
                // FIXED: Calculate progress that ONLY moves forward
                if (data.completed !== undefined && data.total !== undefined) {
                    $('#document-progress').text(`${data.completed} / ${data.total}`);
                    
                    if (data.total === 1) {
                        // Single document: show 30% when starting to process
                        $('#main-progress').css('width', '30%');
                    } else {
                        // Multiple documents: calculate forward-only progress
                        const completedDocs = data.completed; // Documents already done
                        const currentDocIndex = data.current_index || 0; // Current document being processed
                        const totalDocs = data.total;
                        
                        // Each document gets equal slice of 90% (reserve 10% for completion)
                        const docSliceSize = 90 / totalDocs;
                        const baseProgress = completedDocs * docSliceSize;
                        const currentDocProgress = 0.15 * docSliceSize; // 15% into current document
                        
                        const totalProgress = baseProgress + currentDocProgress;
                        $('#main-progress').css('width', `${Math.min(90, totalProgress)}%`);
                    }
                }
                break;
                
            case 'extracting':
                $('#progress-status').text(data.message);
                if (data.current_document) {
                    $('#current-document').text(data.current_document);
                }
                
                // FIXED: Ensure progress only moves forward during extraction
                if (data.total === 1) {
                    $('#main-progress').css('width', '60%');
                } else if (data.completed !== undefined && data.total !== undefined) {
                    // Multiple documents: extraction phase
                    const completedDocs = data.completed;
                    const totalDocs = data.total;
                    
                    const docSliceSize = 90 / totalDocs;
                    const baseProgress = completedDocs * docSliceSize;
                    const currentDocProgress = 0.5 * docSliceSize; // 50% into current document
                    
                    const totalProgress = baseProgress + currentDocProgress;
                    $('#main-progress').css('width', `${Math.min(90, totalProgress)}%`);
                }
                break;
                
            case 'processed':
                $('#progress-status').text(data.message);
                if (data.current_document) {
                    updateFileStatus(data.current_index, 'complete', data.current_document);
                }
                
                if (data.completed !== undefined && data.total !== undefined) {
                    $('#document-progress').text(`${data.completed} / ${data.total}`);
                    
                    if (data.total === 1) {
                        // Single document: show 90% when processing is done
                        $('#main-progress').css('width', '90%');
                    } else {
                        // Multiple documents: document completed
                        const completedDocs = data.completed; // This includes the just-completed document
                        const totalDocs = data.total;
                        
                        const docSliceSize = 90 / totalDocs;
                        const totalProgress = completedDocs * docSliceSize;
                        
                        $('#main-progress').css('width', `${Math.min(90, totalProgress)}%`);
                    }
                }
                break;
                
            case 'complete':
                $('#main-progress').css('width', '100%').removeClass('progress-bar-animated progress-bar-enhanced');
                $('#progress-status').text('Extraction complete!');
                
                // Store results and show confirmation
                extractionResults = data.results;
                showConfirmationDialog(data.results);
                break;
                
            case 'error':
                $('#main-progress').removeClass('progress-bar-animated progress-bar-enhanced').addClass('bg-danger');
                showError('Extraction failed: ' + data.message);
                $('#extract-btn').prop('disabled', false);
                break;
        }
    }
    
    function showConfirmationDialog(results) {
        // Hide progress section and show confirmation
        $('#progress-section').hide();
        $('#confirmation-section').show();
        
        // Populate summary
        const summaryHtml = `
            <strong>Extraction Summary:</strong><br>
            • Documents processed: ${results.processed_count} / ${results.total_count}<br>
            • Total learning goals extracted: ${results.total_goals}<br>
            • Category: "${results.category_title}"
        `;
        $('#confirmation-summary').html(summaryHtml);
        
        // Show results preview
        showResultsPreview(results);
        
        // Re-enable the extract button
        $('#extract-btn').prop('disabled', false);
    }
    
    function showResultsPreview(results) {
        const resultsContainer = $('#results-preview');
        resultsContainer.empty();
        
        const extractionResults = results.extraction_results || [];
        const showSample = extractionResults.length > 10;
        const documentsToShow = showSample ? extractionResults.slice(0, 5) : extractionResults;
        
        // Show sample warning if needed
        if (showSample) {
            $('#sample-warning').show();
        } else {
            $('#sample-warning').hide();
        }
        
        // Add results
        documentsToShow.forEach(result => {
            const goals = result.goals || [];
            const goalsHtml = goals.map(goal => `<li>${goal}</li>`).join('');
            
            const resultHtml = `
                <div class="document-result">
                    <h6>
                        <i class="bi bi-file-earmark-text"></i> ${result.document_name}
                        <small class="text-muted">(${goals.length} goals)</small>
                    </h6>
                    <div class="mb-2">
                        <small class="text-muted">
                            Creator: ${result.creator || 'Unknown'} | 
                            Course: ${result.course_name || 'No Course'}
                        </small>
                    </div>
                    <ul class="goals-list">
                        ${goalsHtml}
                </ul>
            </div>
        `;
            resultsContainer.append(resultHtml);
        });
        
        // Add summary if showing sample
        if (showSample) {
            const remainingCount = extractionResults.length - documentsToShow.length;
            const additionalInfo = `
                <div class="alert alert-info mt-3">
                    <i class="bi bi-info-circle"></i>
                    <strong>Additional Files:</strong> ${remainingCount} more documents were processed. 
                    All results will be saved when you confirm.
                </div>
            `;
            resultsContainer.append(additionalInfo);
        }
        
        // Show failures if any
        if (results.failures && results.failures.length > 0) {
            const failuresHtml = results.failures.map(failure => 
                `<li><strong>${failure.document_name}:</strong> ${failure.error}</li>`
            ).join('');
            
            const failuresSection = `
                <div class="alert alert-warning mt-3">
                    <h6><i class="bi bi-exclamation-triangle"></i> Some files failed to process:</h6>
                    <ul class="mb-0">
                        ${failuresHtml}
                    </ul>
                </div>
            `;
            resultsContainer.append(failuresSection);
        }
    }
    
    function confirmAndSaveResults() {
        if (!extractionResults) {
            showError('No extraction results to save.');
            return;
        }
        
        $('#confirm-save-btn').prop('disabled', true).html('<i class="bi bi-hourglass-split"></i> Saving...');
        
        const confirmData = {
            extraction_results: extractionResults.extraction_results,
            category_title: extractionResults.category_title
        };
        
        $.ajax({
            url: '/api/confirm-bulk-extraction',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(confirmData),
            success: function(response) {
                if (response.success) {
                    // Show success message
                    const successHtml = `
                        <div class="alert alert-success">
                            <h6><i class="bi bi-check-circle"></i> Learning Goals Saved Successfully!</h6>
                            <p class="mb-1">• Documents updated: ${response.saved_count} / ${response.total_count}</p>
                            <p class="mb-0">• Category: "${extractionResults.category_title}"</p>
                        </div>
                    `;
                    
                    if (response.failures && response.failures.length > 0) {
                        const failuresHtml = response.failures.map(failure => 
                            `<li><strong>${failure.document_name}:</strong> ${failure.error}</li>`
                        ).join('');
                        
                        successHtml += `
                            <div class="alert alert-warning mt-2">
                                <h6>Some saves failed:</h6>
                                <ul class="mb-0">${failuresHtml}</ul>
                            </div>
                        `;
                    }
                    
                    $('#confirmation-section').html(`
                        <div class="text-center">
                            ${successHtml}
                            <button type="button" class="btn btn-primary mt-3" onclick="location.reload()">
                                <i class="bi bi-arrow-clockwise"></i> Start New Extraction
                            </button>
                        </div>
                    `);
                } else {
                    showError('Failed to save results: ' + response.message);
                    $('#confirm-save-btn').prop('disabled', false).html('<i class="bi bi-check-lg"></i> Save Learning Goals');
                }
            },
            error: function() {
                showError('Failed to save results. Please try again.');
                $('#confirm-save-btn').prop('disabled', false).html('<i class="bi bi-check-lg"></i> Save Learning Goals');
            }
        });
    }
    
    function goBackToForm() {
        // Hide confirmation and show form again
        $('#confirmation-section').hide();
        $('#progress-section').hide();
        $('#extract-btn').prop('disabled', false);
        
        // Reset the form state
        extractionResults = null;
        
        // Scroll to top
        $('html, body').animate({ scrollTop: 0 }, 500);
    }
    
    function cancelExtraction() {
        if (confirm('Are you sure you want to cancel? All extracted results will be lost.')) {
            location.reload();
        }
    }
    
    function showError(message) {
        // Create a better error display
        const errorHtml = `
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle"></i> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        // Insert error at the top of the card body
        $('.card-body').prepend(errorHtml);
        
        // Auto-dismiss after 8 seconds
        setTimeout(() => {
            $('.alert-danger').fadeOut();
        }, 8000);
    }
    
    // =====================================
    // PROMPT DELETION FUNCTIONALITY
    // =====================================
    
    function loadAllPrompts() {
        $.ajax({
            url: '/api/get-all-prompts',
            method: 'GET'
        })
        .done(function(response) {
            if (response.success && response.prompts) {
                allPrompts = response.prompts;
                populateAllPromptsDropdown();
            } else {
                console.log('Failed to load all prompts:', response.message);
            }
        })
        .fail(function() {
            console.log('Error loading all prompts');
        });
    }
    
    function populateAllPromptsDropdown() {
        const select = $('#deletion-prompt-select');
        select.empty().append('<option value="">Choose a prompt...</option>');
        
        allPrompts.forEach((prompt) => {
            const status = [];
            if (prompt.is_saved) status.push('Saved');
            if (prompt.is_used) status.push('Used');
            
            const statusText = status.length > 0 ? ` (${status.join(', ')})` : '';
            
            select.append(`<option value="${prompt.title}">${prompt.title}${statusText}</option>`);
        });
    }
    
    function onDeletionPromptChange() {
        const selectedPrompt = $('#deletion-prompt-select').val();
        
        if (!selectedPrompt) {
            $('#prompt-files-container').html('<div class="text-muted text-center"><small>Select a prompt to see files</small></div>');
            $('#deletion-actions').hide();
            // Reset checkbox state
            $('#delete-prompt-if-empty').prop('disabled', true).prop('checked', false);
            $('#delete-prompt-checkbox-label').addClass('text-muted');
            $('#delete-prompt-help').hide();
            return;
        }
        
        // Load files for this prompt
        loadFilesForPrompt(selectedPrompt);
    }
    
    function loadFilesForPrompt(promptTitle) {
        $('#prompt-files-container').html('<div class="text-center"><div class="spinner-border spinner-border-sm" role="status"></div> Loading files...</div>');
        
        $.ajax({
            url: `/api/get-files-by-prompt/${encodeURIComponent(promptTitle)}`,
            method: 'GET'
        })
        .done(function(response) {
            if (response.success) {
                displayFilesForDeletion(response.files, promptTitle);
                // Show deletion actions if there are files OR if it's a saved prompt (even with no files)
                const selectedPromptData = allPrompts.find(p => p.title === promptTitle);
                const isUnusedSavedPrompt = selectedPromptData && selectedPromptData.is_saved && response.files.length === 0;
                
                if (response.files.length > 0 || isUnusedSavedPrompt) {
                    $('#deletion-actions').show();
                } else {
                    $('#deletion-actions').hide();
                }
            } else {
                $('#prompt-files-container').html(`<div class="text-danger text-center"><small>Error: ${response.message}</small></div>`);
                $('#deletion-actions').hide();
            }
        })
        .fail(function() {
            $('#prompt-files-container').html('<div class="text-danger text-center"><small>Error loading files</small></div>');
            $('#deletion-actions').hide();
        });
    }
    
    function displayFilesForDeletion(files, promptTitle) {
        selectedFilesForDeletion.clear();
        
        if (files.length === 0) {
            // Check if this is a saved prompt with no files
            const selectedPromptData = allPrompts.find(p => p.title === promptTitle);
            const isUnusedSavedPrompt = selectedPromptData && selectedPromptData.is_saved;
            
            if (isUnusedSavedPrompt) {
                $('#prompt-files-container').html(`
                    <div class="alert alert-info text-center">
                        <i class="bi bi-info-circle"></i>
                        <strong>No files found with this prompt</strong><br>
                        <small>This is a saved prompt that is not currently used in any documents. You can delete the prompt itself if desired.</small>
                    </div>
                `);
                // Enable deletion for unused saved prompts
                $('#delete-prompt-goals-btn').prop('disabled', false);
                $('#delete-prompt-goals-btn').html('<i class="bi bi-trash3"></i> Delete Prompt');
                // Enable the checkbox for unused prompts
                $('#delete-prompt-if-empty').prop('disabled', false).prop('checked', true);
                $('#delete-prompt-checkbox-label').removeClass('text-muted');
                $('#delete-prompt-help').hide();
            } else {
                $('#prompt-files-container').html('<div class="text-muted text-center"><small>No files found with this prompt</small></div>');
                $('#delete-prompt-goals-btn').prop('disabled', true);
                $('#delete-prompt-goals-btn').html('<i class="bi bi-trash3"></i> Delete Selected');
                // Disable the checkbox since there's nothing to delete
                $('#delete-prompt-if-empty').prop('disabled', true).prop('checked', false);
                $('#delete-prompt-checkbox-label').addClass('text-muted');
                $('#delete-prompt-help').hide();
            }
            return;
        }
        
        // Files found - show normal file selection interface
        $('#delete-prompt-goals-btn').html('<i class="bi bi-trash3"></i> Delete Selected');
        $('#delete-prompt-goals-btn').prop('disabled', true);
        // Initially disable the checkbox - will be enabled only if all files are selected
        $('#delete-prompt-if-empty').prop('disabled', true).prop('checked', false);
        $('#delete-prompt-checkbox-label').addClass('text-muted');
        $('#delete-prompt-help').show().text('Select all files to enable prompt deletion');
        
        let html = '';
        files.forEach((file) => {
            html += `
                <div class="form-check mb-2">
                    <input class="form-check-input file-deletion-checkbox" type="checkbox" 
                           id="file-${file.id}" value="${file.id}" 
                           data-file-name="${file.name}" data-goals-count="${file.goals_count}">
                    <label class="form-check-label" for="file-${file.id}">
                        <strong>${file.name}</strong><br>
                        <small class="text-muted">
                            📄 ${file.original_filename} | 👤 ${file.creator || 'Unknown'}
                            ${file.course_name ? ` | 📚 ${file.course_name}` : ''}
                            | 🎯 ${file.goals_count} goals
                        </small>
                    </label>
                </div>
            `;
        });
        
        $('#prompt-files-container').html(html);
        
        // Add event listeners for checkboxes
        $('.file-deletion-checkbox').change(function() {
            const fileId = $(this).val();
            if ($(this).is(':checked')) {
                selectedFilesForDeletion.add(fileId);
            } else {
                selectedFilesForDeletion.delete(fileId);
            }
            
            $('#delete-prompt-goals-btn').prop('disabled', selectedFilesForDeletion.size === 0);
            
            // Enable/disable the "delete prompt if empty" checkbox based on selection
            updateDeletePromptCheckbox(files.length);
        });
    }
    
    function selectAllFilesForDeletion() {
        const checkboxes = $('.file-deletion-checkbox');
        const allChecked = checkboxes.length > 0 && checkboxes.filter(':checked').length === checkboxes.length;
        
        if (allChecked) {
            // Uncheck all
            checkboxes.prop('checked', false);
            selectedFilesForDeletion.clear();
            $('#select-all-files-btn').html('<i class="bi bi-check-square"></i> Select All');
        } else {
            // Check all
            checkboxes.prop('checked', true);
            selectedFilesForDeletion.clear();
            checkboxes.each(function() {
                selectedFilesForDeletion.add($(this).val());
            });
            $('#select-all-files-btn').html('<i class="bi bi-square"></i> Clear All');
        }
        
        $('#delete-prompt-goals-btn').prop('disabled', selectedFilesForDeletion.size === 0);
        
        // Update the delete prompt checkbox
        updateDeletePromptCheckbox(checkboxes.length);
    }
    
    function updateDeletePromptCheckbox(totalFiles) {
        const selectedCount = selectedFilesForDeletion.size;
        
        if (selectedCount === totalFiles && totalFiles > 0) {
            // All files are selected - enable the checkbox
            $('#delete-prompt-if-empty').prop('disabled', false);
            $('#delete-prompt-checkbox-label').removeClass('text-muted');
            $('#delete-prompt-help').hide();
        } else if (totalFiles > 0) {
            // Not all files selected - disable the checkbox and show help
            $('#delete-prompt-if-empty').prop('disabled', true).prop('checked', false);
            $('#delete-prompt-checkbox-label').addClass('text-muted');
            $('#delete-prompt-help').show().text('Select all files to enable prompt deletion');
        } else {
            // No files (handled elsewhere) - just hide help
            $('#delete-prompt-help').hide();
        }
    }
    
    function deletePromptGoals() {
        const promptTitle = $('#deletion-prompt-select').val();
        const deletePromptIfEmpty = $('#delete-prompt-if-empty').is(':checked');
        
        if (!promptTitle) {
            return;
        }
        
        // Check if this is an unused saved prompt deletion
        const selectedPromptData = allPrompts.find(p => p.title === promptTitle);
        const isUnusedSavedPrompt = selectedPromptData && selectedPromptData.is_saved && selectedFilesForDeletion.size === 0;
        
        if (!isUnusedSavedPrompt && selectedFilesForDeletion.size === 0) {
            return;
        }
        
        let confirmMessage;
        
        if (isUnusedSavedPrompt) {
            // Confirmation for deleting unused saved prompt
            confirmMessage = `Are you sure you want to delete the saved prompt "${promptTitle}"?

This prompt is not currently used in any documents and will be permanently removed from your saved prompts.

This action cannot be undone.`;
        } else {
            // Confirmation for deleting learning goals from files
            const fileNames = Array.from(selectedFilesForDeletion).map(fileId => {
                const checkbox = $(`#file-${fileId}`);
                return checkbox.data('file-name');
            });
            
            const totalGoals = Array.from(selectedFilesForDeletion).reduce((sum, fileId) => {
                const checkbox = $(`#file-${fileId}`);
                return sum + (checkbox.data('goals-count') || 0);
            }, 0);
            
            confirmMessage = `Are you sure you want to delete learning goals for "${promptTitle}" from ${selectedFilesForDeletion.size} file(s)?
        
Files: ${fileNames.join(', ')}
Total goals to be deleted: ${totalGoals}

${deletePromptIfEmpty ? 'The prompt itself will also be deleted if no other files use it.' : ''}

This action cannot be undone, but deleted goals will be archived.`;
        }
        
        if (!confirm(confirmMessage)) {
            return;
        }
        
        // Perform deletion
        const deleteBtn = $('#delete-prompt-goals-btn');
        deleteBtn.prop('disabled', true).html('<i class="bi bi-spinner-border spinner-border-sm"></i> Deleting...');
        
        $.ajax({
            url: '/api/delete-learning-goals-by-prompt',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                prompt_title: promptTitle,
                file_ids: Array.from(selectedFilesForDeletion),
                delete_prompt_if_empty: isUnusedSavedPrompt ? true : deletePromptIfEmpty
            })
        })
        .done(function(response) {
            if (response.success) {
                let message;
                
                if (isUnusedSavedPrompt) {
                    // Success message for deleting unused saved prompt
                    message = `✅ Successfully deleted prompt!\n\n`;
                    message += `• Prompt "${promptTitle}" was removed from saved prompts\n`;
                } else {
                    // Success message for deleting learning goals from files
                    message = `✅ Successfully deleted learning goals!\n\n`;
                    message += `• Files processed: ${response.deleted_count}/${response.total_requested}\n`;
                    message += `• Goals archived: ${response.archived_goals}\n`;
                    
                    if (response.prompt_deleted) {
                        message += `• Prompt "${promptTitle}" was also deleted\n`;
                    }
                    
                    if (response.deletion_details && response.deletion_details.length > 0) {
                        message += `\nDetails:\n`;
                        response.deletion_details.forEach(detail => {
                            if (detail.error) {
                                message += `• ${detail.file_name}: Error - ${detail.error}\n`;
                            } else {
                                message += `• ${detail.file_name}: ${detail.goals_deleted} goals deleted\n`;
                            }
                        });
                    }
                }
                
                alert(message);
                
                // Refresh the prompt list and reset the form
                loadAllPrompts();
                $('#deletion-prompt-select').val('');
                $('#prompt-files-container').html('<div class="text-muted text-center"><small>Select a prompt to see files</small></div>');
                $('#deletion-actions').hide();
                selectedFilesForDeletion.clear();
                
            } else {
                alert(`❌ Deletion failed: ${response.message}`);
            }
        })
        .fail(function() {
            alert('❌ Error performing deletion. Please try again.');
        })
        .always(function() {
            deleteBtn.prop('disabled', false).html('<i class="bi bi-trash3"></i> Delete Selected');
        });
    }

    // Expose toggle function globally
    window.toggleExpand = toggleExpand;
});
</script>
{% endblock %} 