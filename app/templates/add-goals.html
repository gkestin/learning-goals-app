{% extends "base.html" %}

{% block title %}Add Learning Goals - Learning Goals Extractor{% endblock %}

{% block extra_css %}
<style>
    .hierarchical-selector {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        max-height: 400px;
        overflow-y: auto;
    }
    
    .creator-item, .course-item, .document-item {
        margin-bottom: 8px;
        padding: 8px 12px;
        border-radius: 4px;
        background-color: white;
        border: 1px solid #e9ecef;
    }
    
    .creator-item {
        border-left: 4px solid #007bff;
    }
    
    .course-item {
        border-left: 4px solid #ffc107;
        margin-left: 20px;
    }
    
    .document-item {
        border-left: 4px solid #6c757d;
        margin-left: 40px;
    }
    
    .expand-icon {
        transition: transform 0.3s ease;
        cursor: pointer;
        margin-right: 8px;
    }
    
    .expanded .expand-icon {
        transform: rotate(90deg);
    }
    
    .children {
        margin-top: 8px;
        display: none;
    }
    
    .expanded .children {
        display: block;
    }
    
    .selection-summary {
        background-color: #e3f2fd;
        border: 1px solid #90caf9;
        border-radius: 4px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .prompt-section {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .copy-section {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .progress-section {
        display: none;
        background-color: #e8f5e8;
        border: 1px solid #c8e6c9;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .document-count {
        font-size: 0.875rem;
        color: #6c757d;
        font-weight: normal;
    }
    
    .checkbox-label {
        display: flex;
        align-items: center;
        cursor: pointer;
    }
    
    .checkbox-label input[type="checkbox"] {
        margin-right: 8px;
    }
    
    .item-info {
        flex-grow: 1;
    }
    
    .custom-prompt-toggle {
        margin-bottom: 15px;
    }
    
    .saved-prompts {
        margin-bottom: 15px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h2 class="card-title h4 mb-0">
                        <i class="bi bi-plus-circle"></i> Add Learning Goals with Custom Prompts
                    </h2>
                    <small>Extract additional learning goals using custom prompts and organize them by category</small>
                </div>
                <div class="card-body">
                    


                    <!-- Document Selection Section -->
                    <div class="mb-4">
                        <h5 class="mb-3">
                            <i class="bi bi-check2-square"></i> Select Documents
                        </h5>
                        
                        <div class="mb-3">
                            <button type="button" class="btn btn-sm btn-outline-primary me-2" id="select-all-btn">
                                <i class="bi bi-check-square"></i> Select All
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary me-2" id="clear-all-btn">
                                <i class="bi bi-square"></i> Clear All
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-info" id="refresh-documents-btn">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                        </div>
                        
                        <div id="selection-summary" class="selection-summary" style="display: none;">
                            <strong>Selected:</strong> <span id="selected-count">0</span> documents
                        </div>
                        
                        <div id="document-selector" class="hierarchical-selector">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading documents...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Custom Prompt Section -->
                    <div class="prompt-section">
                        <h5 class="mb-3">
                            <i class="bi bi-chat-square-text"></i> Custom Prompt Configuration
                        </h5>
                        
                        <!-- Saved Prompts -->
                        <div class="saved-prompts">
                            <label for="saved-prompt-select" class="form-label">Use Saved Prompt (Optional):</label>
                            <select id="saved-prompt-select" class="form-select">
                                <option value="">Create new prompt</option>
                            </select>
                        </div>
                        
                        <!-- Category Title -->
                        <div class="mb-3">
                            <label for="category-title" class="form-label">Category Title *</label>
                            <input type="text" id="category-title" class="form-control" placeholder="e.g., 'Graphing Skills', 'Basic Concepts', 'Advanced Topics'" required>
                            <div class="form-text">This will be the heading under which these learning goals are organized.</div>
                        </div>
                        
                        <!-- System Prompt -->
                        <div class="mb-3">
                            <label for="system-prompt" class="form-label">System Message *</label>
                            <textarea id="system-prompt" class="form-control" rows="6" placeholder="Enter your custom AI instructions..." required></textarea>
                            <div class="form-text">
                                Provide specific instructions for what types of learning goals to extract. 
                                Include instructions for what to return if no relevant goals are found.
                            </div>
                        </div>
                        
                        <!-- User Prompt -->
                        <div class="mb-3">
                            <label for="user-prompt" class="form-label">User Message</label>
                            <input type="text" id="user-prompt" class="form-control" value="Extract learning goals from the following text:" placeholder="Extract learning goals from the following text:">
                            <div class="form-text">
                                The message sent to the AI before the document content.
                                <span class="float-end">
                                    <small>Model:</small>
                                    <select class="form-select form-select-sm d-inline-block" id="model" name="model" style="width: auto; min-width: 120px;">
                                        <option value="gpt-4o" selected>GPT-4o</option>
                                        <option value="gpt-4.1">GPT-4.1</option>
                                    </select>
                                </span>
                            </div>
                        </div>
                        
                        <!-- Save Prompt Option -->
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="save-prompt" checked>
                                <label class="form-check-label" for="save-prompt">
                                    Save this prompt for future reuse
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="text-center">
                        <button type="button" class="btn btn-success btn-lg" id="extract-btn" disabled>
                            <i class="bi bi-magic"></i> Extract Learning Goals
                        </button>
                    </div>

                    <!-- Progress Section -->
                    <div class="progress-section" id="progress-section">
                        <h5 class="mb-3">
                            <i class="bi bi-hourglass-split"></i> Extracting Learning Goals
                        </h5>
                        <div class="progress mb-3">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" id="main-progress" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div id="progress-details">
                            <div><strong>Status:</strong> <span id="progress-status">Preparing...</span></div>
                            <div><strong>Current:</strong> <span id="current-document">-</span></div>
                            <div><strong>Progress:</strong> <span id="document-progress">0 / 0</span></div>
                        </div>
                        <div id="extraction-results" class="mt-4" style="display: none;">
                            <h6>Extraction Results:</h6>
                            <div id="results-summary"></div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='lock-manager.js') }}"></script>
<script>
$(document).ready(function() {
    let documents = [];
    let selectedDocuments = new Set();
    let savedPrompts = [];
    
    // Load documents and saved prompts
    loadDocuments();
    loadSavedPrompts();
    
    // Event handlers
    $('#select-all-btn').click(selectAllDocuments);
    $('#clear-all-btn').click(clearAllDocuments);
    $('#refresh-documents-btn').click(loadDocuments);

    $('#extract-btn').click(extractLearningGoals);
    $('#saved-prompt-select').change(loadSavedPrompt);
    
    // Validation
    $('#category-title, #system-prompt').on('input', validateForm);
    
    function loadDocuments() {
        $('#document-selector').html(`
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading documents...</p>
            </div>
        `);
        
        $.ajax({
            url: '/api/get-documents-hierarchical',
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    documents = response.documents;
                    renderHierarchicalSelector(response.hierarchy);
                } else {
                    showError('Failed to load documents: ' + response.message);
                }
            },
            error: function() {
                showError('Failed to load documents. Please try again.');
            }
        });
    }
    
    function loadSavedPrompts() {
        $.ajax({
            url: '/api/get-saved-prompts',
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    savedPrompts = response.prompts;
                    populateSavedPrompts();
                }
            },
            error: function() {
                console.log('No saved prompts available');
            }
        });
    }
    
    function populateSavedPrompts() {
        const select = $('#saved-prompt-select');
        select.find('option:not(:first)').remove();
        
        savedPrompts.forEach((prompt, index) => {
            select.append(`<option value="${index}">${prompt.title}</option>`);
        });
    }
    
    function loadSavedPrompt() {
        const index = $('#saved-prompt-select').val();
        if (index && savedPrompts[index]) {
            const prompt = savedPrompts[index];
            $('#category-title').val(prompt.title);
            $('#system-prompt').val(prompt.system_prompt);
            $('#user-prompt').val(prompt.user_prompt);
            validateForm();
        }
    }
    
    function renderHierarchicalSelector(hierarchy) {
        let html = '';
        let elementCounter = 0; // Use counter for unique IDs instead of names
        
        for (const [creator, creatorData] of Object.entries(hierarchy)) {
            const creatorId = `creator-${elementCounter++}`;
            const creatorDocCount = Object.values(creatorData.courses).reduce((sum, course) => sum + course.documents.length, 0);
            
            html += `
                <div class="creator-item" data-creator="${creator}">
                    <div class="checkbox-label">
                        <input type="checkbox" class="creator-checkbox" data-creator="${creator}">
                        <i class="bi bi-chevron-right expand-icon" onclick="toggleExpand('${creatorId}')"></i>
                        <div class="item-info">
                            <strong>${creator}</strong>
                            <span class="document-count">(${creatorDocCount} documents)</span>
                            ${creatorData.institution ? `<br><small class="text-muted">${creatorData.institution}</small>` : ''}
                        </div>
                    </div>
                    <div class="children" id="${creatorId}">
            `;
            
            for (const [courseName, courseData] of Object.entries(creatorData.courses)) {
                const courseId = `course-${elementCounter++}`;
                
                html += `
                    <div class="course-item" data-course="${courseName}" data-creator="${creator}">
                        <div class="checkbox-label">
                            <input type="checkbox" class="course-checkbox" data-creator="${creator}" data-course="${courseName}">
                            <i class="bi bi-chevron-right expand-icon" onclick="toggleExpand('${courseId}')"></i>
                            <div class="item-info">
                                <strong>${courseName}</strong>
                                <span class="document-count">(${courseData.documents.length} documents)</span>
                            </div>
                        </div>
                        <div class="children" id="${courseId}">
                `;
                
                courseData.documents.forEach(doc => {
                    html += `
                        <div class="document-item" data-document-id="${doc.id}">
                            <div class="checkbox-label">
                                <input type="checkbox" class="document-checkbox" data-document-id="${doc.id}" data-creator="${creator}" data-course="${courseName}">
                                <div class="item-info">
                                    <strong>${doc.name}</strong>
                                    <br><small class="text-muted">${doc.doc_type || 'Document'}</small>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            html += `
                    </div>
                </div>
            `;
        }
        
        if (html === '') {
            html = `
                <div class="text-center text-muted">
                    <i class="bi bi-folder-x" style="font-size: 2rem;"></i>
                    <p class="mt-2">No documents found. <a href="{{ url_for('main.index') }}">Upload some documents</a> first.</p>
                </div>
            `;
        }
        
        $('#document-selector').html(html);
        
        // Ensure all elements start collapsed
        $('.creator-item, .course-item').removeClass('expanded');
        $('.children').hide();
        
        // Set up event handlers for checkboxes
        setupCheckboxHandlers();
    }
    
    function setupCheckboxHandlers() {
        // Creator checkboxes
        $('.creator-checkbox').change(function() {
            const creator = $(this).data('creator');
            const checked = $(this).prop('checked');
            
            // Update all courses and documents for this creator
            $(`.course-checkbox[data-creator="${creator}"]`).prop('checked', checked);
            $(`.document-checkbox[data-creator="${creator}"]`).prop('checked', checked);
            
            updateSelectedDocuments();
        });
        
        // Course checkboxes
        $('.course-checkbox').change(function() {
            const creator = $(this).data('creator');
            const course = $(this).data('course');
            const checked = $(this).prop('checked');
            
            // Update all documents for this course
            $(`.document-checkbox[data-creator="${creator}"][data-course="${course}"]`).prop('checked', checked);
            
            // Update creator checkbox state
            updateCreatorCheckbox(creator);
            updateSelectedDocuments();
        });
        
        // Document checkboxes
        $('.document-checkbox').change(function() {
            const creator = $(this).data('creator');
            const course = $(this).data('course');
            
            updateCourseCheckbox(creator, course);
            updateCreatorCheckbox(creator);
            updateSelectedDocuments();
        });
    }
    
    function updateCreatorCheckbox(creator) {
        const allCourseCheckboxes = $(`.course-checkbox[data-creator="${creator}"]`);
        const checkedCourseCheckboxes = $(`.course-checkbox[data-creator="${creator}"]:checked`);
        const creatorCheckbox = $(`.creator-checkbox[data-creator="${creator}"]`);
        
        if (checkedCourseCheckboxes.length === 0) {
            creatorCheckbox.prop('checked', false);
        } else if (checkedCourseCheckboxes.length === allCourseCheckboxes.length) {
            creatorCheckbox.prop('checked', true);
        } else {
            creatorCheckbox.prop('indeterminate', true);
        }
    }
    
    function updateCourseCheckbox(creator, course) {
        const allDocCheckboxes = $(`.document-checkbox[data-creator="${creator}"][data-course="${course}"]`);
        const checkedDocCheckboxes = $(`.document-checkbox[data-creator="${creator}"][data-course="${course}"]:checked`);
        const courseCheckbox = $(`.course-checkbox[data-creator="${creator}"][data-course="${course}"]`);
        
        if (checkedDocCheckboxes.length === 0) {
            courseCheckbox.prop('checked', false);
        } else if (checkedDocCheckboxes.length === allDocCheckboxes.length) {
            courseCheckbox.prop('checked', true);
        } else {
            courseCheckbox.prop('indeterminate', true);
        }
    }
    
    function updateSelectedDocuments() {
        selectedDocuments.clear();
        $('.document-checkbox:checked').each(function() {
            selectedDocuments.add($(this).data('document-id'));
        });
        
        $('#selected-count').text(selectedDocuments.size);
        if (selectedDocuments.size > 0) {
            $('#selection-summary').show();
        } else {
            $('#selection-summary').hide();
        }
        
        validateForm();
    }
    
    function selectAllDocuments() {
        $('.creator-checkbox, .course-checkbox, .document-checkbox').prop('checked', true);
        updateSelectedDocuments();
    }
    
    function clearAllDocuments() {
        $('.creator-checkbox, .course-checkbox, .document-checkbox').prop('checked', false);
        updateSelectedDocuments();
    }
    
    function toggleExpand(elementId) {
        const $children = $(`#${elementId}`);
        const $parent = $children.parent(); // Get the direct parent (creator-item or course-item)
        const $icon = $parent.find('.expand-icon').first();
        
        if ($parent.hasClass('expanded')) {
            // Currently expanded, so collapse
            $parent.removeClass('expanded');
            $children.slideUp(200);
        } else {
            // Currently collapsed, so expand
            $parent.addClass('expanded');
            $children.slideDown(200);
        }
    }
    
    function validateForm() {
        const hasSelection = selectedDocuments.size > 0;
        const hasTitle = $('#category-title').val().trim().length > 0;
        const hasSystemPrompt = $('#system-prompt').val().trim().length > 0;
        
        $('#extract-btn').prop('disabled', !(hasSelection && hasTitle && hasSystemPrompt));
    }
    

    
    function extractLearningGoals() {
        const categoryTitle = $('#category-title').val().trim();
        const systemPrompt = $('#system-prompt').val().trim();
        const userPrompt = $('#user-prompt').val().trim();
        const selectedModel = $('#model').val();
        const savePrompt = $('#save-prompt').prop('checked');
        
        if (!categoryTitle || !systemPrompt) {
            showError('Please fill in all required fields.');
            return;
        }
        
        if (selectedDocuments.size === 0) {
            showError('Please select at least one document.');
            return;
        }
        
        // Show progress section
        $('#progress-section').show();
        $('#extract-btn').prop('disabled', true);
        
        // Start extraction
        const extractionData = {
            document_ids: Array.from(selectedDocuments),
            category_title: categoryTitle,
            system_prompt: systemPrompt,
            user_prompt: userPrompt,
            model: selectedModel,
            save_prompt: savePrompt
        };
        
        $.ajax({
            url: '/api/extract-bulk-learning-goals',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(extractionData),
            success: function(response) {
                if (response.success) {
                    showExtractionResults(response);
                } else {
                    showError('Extraction failed: ' + response.message);
                }
            },
            error: function() {
                showError('Extraction failed. Please try again.');
            },
            complete: function() {
                $('#extract-btn').prop('disabled', false);
            }
        });
    }
    
    function showExtractionResults(response) {
        $('#main-progress').css('width', '100%');
        $('#progress-status').text('Complete!');
        $('#document-progress').text(`${response.processed_count} / ${response.total_count}`);
        
        let resultsHtml = `
            <div class="alert alert-success">
                <h6>Extraction Complete!</h6>
                <ul class="mb-0">
                    <li>Documents processed: ${response.processed_count}</li>
                    <li>Total learning goals extracted: ${response.total_goals}</li>
                    <li>Category: "${response.category_title}"</li>
                </ul>
            </div>
        `;
        
        if (response.failures && response.failures.length > 0) {
            resultsHtml += `
                <div class="alert alert-warning">
                    <h6>Some documents failed:</h6>
                    <ul class="mb-0">
                        ${response.failures.map(failure => `<li>${failure.document_name}: ${failure.error}</li>`).join('')}
                    </ul>
                </div>
            `;
        }
        
        $('#results-summary').html(resultsHtml);
        $('#extraction-results').show();
        
        // Auto-hide after 10 seconds
        setTimeout(() => {
            $('#progress-section').fadeOut();
        }, 10000);
    }
    
    function showError(message) {
        alert(message); // TODO: Replace with better error handling
    }
    
    // Expose toggle function globally
    window.toggleExpand = toggleExpand;
});
</script>
{% endblock %} 