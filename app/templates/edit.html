{% extends "base.html" %}

{% block title %}Edit Learning Goals - Learning Goals Extractor{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.13.2/themes/base/jquery-ui.min.css">
<style>
    .learning-goal-item {
        margin-bottom: 10px;
        display: flex;
        align-items: center;
    }
    .learning-goal-item .form-control {
        flex-grow: 1;
    }
    .learning-goal-item .btn-remove {
        margin-left: 10px;
    }
    .add-goal-btn {
        margin-top: 10px;
        margin-bottom: 20px;
    }
    .ui-autocomplete {
        max-height: 200px;
        overflow-y: auto;
        overflow-x: hidden;
        z-index: 9999;
    }
    .saving-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        color: white;
        flex-direction: column;
    }
    .saving-overlay .spinner-border {
        margin-bottom: 20px;
    }
    .saving-message {
        font-size: 1.2rem;
        margin-top: 10px;
        text-align: center;
        max-width: 600px;
    }
    .saving-dots::after {
        display: inline-block;
        animation: ellipsis 1.5s infinite;
        content: ".";
        width: 24px;
        text-align: left;
    }
    @keyframes ellipsis {
        0% { content: "."; }
        25% { content: ".."; }
        50% { content: "..."; }
        75% { content: "...."; }
    }
    .document-card {
        margin-bottom: 30px;
        border: 1px solid #ddd;
        border-radius: 8px;
    }
    .document-card .card-header {
        background-color: #f8f9fa;
        padding: 15px;
        border-bottom: 1px solid #ddd;
    }
    .document-card .card-body {
        padding: 20px;
    }
    .global-metadata-header {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
        padding: 15px 20px;
        border-radius: 8px 8px 0 0;
        margin-bottom: 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }
    .global-metadata-header h3 {
        margin-bottom: 8px;
        color: white;
        font-size: 1.1rem;
    }
    .global-metadata-header .global-help-text {
        margin-bottom: 0;
        color: rgba(255, 255, 255, 0.9);
        font-size: 0.85rem;
    }
    .global-metadata-fields {
        background-color: #eff6ff;
        padding: 20px;
        border-radius: 0 0 8px 8px;
        border: 1px solid #bfdbfe;
        border-top: none;
        margin-bottom: 30px;
    }
    .global-field {
        border: 1px solid #93c5fd;
        transition: all 0.2s ease;
        background-color: rgba(255, 255, 255, 0.8);
    }
    .global-field:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
        background-color: white;
    }
    .metadata-field.inherited-from-global {
        background-color: #f3f4f6;
        color: #6b7280;
        border-color: #d1d5db;
        font-style: italic;
    }
    .metadata-field.inherited-from-global:focus {
        background-color: white;
        color: #374151;
        font-style: normal;
    }
    .global-indicator {
        color: #3b82f6;
        font-weight: 500;
        font-size: 0.75rem;
        display: none;
    }
    .global-indicator.active {
        display: inline;
    }
    .global-indicator.active::before {
        content: "üåê ";
    }
    .global-indicator.active::after {
        content: " (from global)";
    }
    .upload-progress-container {
        margin-top: 20px;
        width: 100%;
        max-width: 500px;
    }
    .progress-phase {
        margin-bottom: 25px;
        padding: 15px;
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .progress-phase-title {
        font-weight: bold;
        margin-bottom: 10px;
        color: #fff;
        font-size: 1.1rem;
    }
    .progress-phase.active {
        background-color: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.3);
    }
    .progress-phase.completed {
        background-color: rgba(40, 167, 69, 0.2);
        border-color: rgba(40, 167, 69, 0.4);
    }
    .upload-progress-file {
        margin-bottom: 12px;
        padding: 12px;
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 6px;
        border: 1px solid rgba(0, 0, 0, 0.1);
    }
    .upload-progress-file .file-name {
        font-weight: bold;
        margin-bottom: 8px;
        color: #333;
        font-size: 0.9rem;
    }
    .upload-progress-file .progress {
        height: 20px;
        background-color: #e9ecef;
    }
    .phase-progress {
        margin-bottom: 10px;
    }
    .phase-progress .progress {
        height: 25px;
        background-color: rgba(255, 255, 255, 0.3);
    }
    .phase-progress .progress-bar {
        font-weight: bold;
        line-height: 25px;
    }
    .warning-banner {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
        font-weight: bold;
        text-align: center;
    }
    .no-upload-notice {
        background-color: #e0f2fe;
        border: 1px solid #b3e5fc;
        color: #0277bd;
        padding: 8px 12px;
        border-radius: 4px;
        margin-bottom: 15px;
        text-align: center;
        font-size: 0.9rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
<div class="row justify-content-center">
    <div class="col-md-10">
            
            <!-- Notice that files haven't been uploaded yet -->
            <div class="no-upload-notice">
                <i class="bi bi-info-circle"></i>
                <small>Files are stored locally and will be uploaded when you save below.</small>
        </div>

            <div class="card">
                <div class="card-header bg-success text-white">
                    <h2 class="card-title h4 mb-0">Edit Learning Goals and Document Metadata</h2>
                </div>
                <div class="card-body">
                    <form id="save-form" method="post" action="{{ url_for('main.save_document_data') }}">
                
                        <!-- Global Metadata Section -->
                        <div class="mb-5">
                            <div class="global-metadata-header">
                                <h3 class="h4 mb-3">
                                    <i class="bi bi-globe2"></i> Global Metadata
                                    <small class="text-muted ms-2">(applies to all documents below)</small>
                                </h3>
                                <p class="global-help-text">
                                    <i class="bi bi-info-circle"></i>
                                    Set values here to automatically apply them to all documents. Individual documents can override these values if needed.
                                </p>
                            </div>
                            <div class="global-metadata-fields">
                                <div class="row g-3">
                        <div class="col-md-6">
                                <label for="global_creator" class="form-label">Creator:</label>
                                        <input type="text" class="form-control global-field" id="global_creator" name="global_creator" placeholder="Enter creator name">
                        </div>
                        <div class="col-md-6">
                                <label for="global_course_name" class="form-label">Course Name:</label>
                                        <input type="text" class="form-control global-field" id="global_course_name" name="global_course_name" placeholder="Enter course name">
                    </div>
                        <div class="col-md-6">
                                <label for="global_institution" class="form-label">Institution:</label>
                                        <input type="text" class="form-control global-field" id="global_institution" name="global_institution" placeholder="Enter institution name">
                        </div>
                        <div class="col-md-6">
                                <label for="global_doc_type" class="form-label">Document Type:</label>
                                        <select class="form-select global-field" id="global_doc_type" name="global_doc_type">
                                            <option value="">Select document type</option>
                                            <option value="Syllabus">Syllabus</option>
                                            <option value="Assignment">Assignment</option>
                                    <option value="Exam">Exam</option>
                                            <option value="Lecture Notes">Lecture Notes</option>
                                            <option value="Lab Manual">Lab Manual</option>
                                            <option value="Project Description">Project Description</option>
                                            <option value="Rubric">Rubric</option>
                                            <option value="Curriculum Guide">Curriculum Guide</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                                    <div class="col-md-12">
                                        <label for="global_notes" class="form-label">Notes:</label>
                                        <textarea class="form-control global-field" id="global_notes" name="global_notes" rows="2" placeholder="Enter any additional notes"></textarea>
                        </div>
                    </div>
                            </div>
                        </div>
            
                        <!-- Individual Documents -->
            {% for document in processed_files %}
                        <div class="document-card">
                <div class="card-header">
                                <h3 class="h6 mb-0">
                                    <i class="bi bi-file-earmark-pdf"></i>
                                    Document {{ loop.index }}: {{ document.original_filename }}
                                    <small class="text-muted">({{ (document.file_size / 1024 / 1024) | round(1) }}MB)</small>
                                </h3>
                </div>
                <div class="card-body">
                                <!-- Document Metadata -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                                <label for="creator_{{ loop.index0 }}" class="form-label">
                                    Creator:
                                    <small class="global-indicator" id="creator_indicator_{{ loop.index0 }}"></small>
                                </label>
                                        <input type="text" class="form-control metadata-field" 
                                               id="creator_{{ loop.index0 }}" 
                                               name="creator_{{ loop.index0 }}" 
                                               data-field-type="creator">
                        </div>
                        <div class="col-md-6">
                                <label for="course_name_{{ loop.index0 }}" class="form-label">
                                    Course Name:
                                    <small class="global-indicator" id="course_name_indicator_{{ loop.index0 }}"></small>
                                </label>
                                        <input type="text" class="form-control metadata-field" 
                                               id="course_name_{{ loop.index0 }}" 
                                               name="course_name_{{ loop.index0 }}" 
                                               data-field-type="course_name">
                    </div>
                        <div class="col-md-6">
                                <label for="institution_{{ loop.index0 }}" class="form-label">
                                    Institution:
                                    <small class="global-indicator" id="institution_indicator_{{ loop.index0 }}"></small>
                                </label>
                                        <input type="text" class="form-control metadata-field" 
                                               id="institution_{{ loop.index0 }}" 
                                               name="institution_{{ loop.index0 }}" 
                                               data-field-type="institution">
                        </div>
                        <div class="col-md-6">
                                <label for="doc_type_{{ loop.index0 }}" class="form-label">
                                    Document Type:
                                    <small class="global-indicator" id="doc_type_indicator_{{ loop.index0 }}"></small>
                                </label>
                                        <select class="form-select metadata-field" 
                                                id="doc_type_{{ loop.index0 }}" 
                                                name="doc_type_{{ loop.index0 }}" 
                                                data-field-type="doc_type">
                                            <option value="">Select document type</option>
                                            <option value="Syllabus">Syllabus</option>
                                            <option value="Assignment">Assignment</option>
                                    <option value="Exam">Exam</option>
                                            <option value="Lecture Notes">Lecture Notes</option>
                                            <option value="Lab Manual">Lab Manual</option>
                                            <option value="Project Description">Project Description</option>
                                            <option value="Rubric">Rubric</option>
                                            <option value="Curriculum Guide">Curriculum Guide</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                                    <div class="col-md-12">
                                        <label for="notes_{{ loop.index0 }}" class="form-label">
                                            Notes:
                                            <small class="global-indicator" id="notes_indicator_{{ loop.index0 }}"></small>
                                        </label>
                                        <textarea class="form-control metadata-field" 
                                                  id="notes_{{ loop.index0 }}" 
                                                  name="notes_{{ loop.index0 }}" 
                                                  rows="2" 
                                                  data-field-type="notes"></textarea>
                        </div>
                        <div class="col-md-12">
                                        <label for="document_name_{{ loop.index0 }}" class="form-label">Document Name (unique per document):</label>
                                        <input type="text" class="form-control metadata-field" 
                                               id="document_name_{{ loop.index0 }}" 
                                               name="document_name_{{ loop.index0 }}" 
                                               value="{{ document.original_filename }}"
                                               data-field-type="name">
                                    </div>
                    </div>
                    
                                <!-- LO Extraction Prompt Display -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="lo_extraction_prompt_{{ loop.index0 }}" class="form-label">LO Extraction Prompt:</label>
                                <div class="prompt-display" id="prompt_display_{{ loop.index0 }}">
                                    <div class="prompt-preview" style="cursor: pointer; padding: 8px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px;">
                                        <span class="prompt-short">{{ (document.lo_extraction_prompt or '')[:50] }}{% if (document.lo_extraction_prompt or '')|length > 50 %}...{% endif %}</span>
                                        <small class="text-muted ms-2">(click to expand)</small>
                                    </div>
                                    <div class="prompt-full" style="display: none; margin-top: 8px;">
                                        <textarea class="form-control" readonly rows="8">{{ document.lo_extraction_prompt or '' }}</textarea>
                                        <small class="text-muted" style="cursor: pointer;">(click to collapse)</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <h4 class="h5 mb-3">Learning Goals:</h4>
                    <div id="learning-goals-container-{{ loop.index0 }}" class="learning-goals-container">
                        {% if document.learning_goals %}
                            {% set doc_index = loop.index0 %}
                            {% for goal in document.learning_goals %}
                                <div class="learning-goal-item">
                                    <input type="text" class="form-control" name="learning_goals_{{ doc_index }}[]" value="{{ goal }}" required>
                                    <button type="button" class="btn btn-danger btn-sm btn-remove">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="learning-goal-item">
                                <input type="text" class="form-control" name="learning_goals_{{ loop.index0 }}[]" required>
                                <button type="button" class="btn btn-danger btn-sm btn-remove">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        {% endif %}
                    </div>
                    
                    <button type="button" data-index="{{ loop.index0 }}" class="btn btn-outline-primary add-goal-btn">
                        <i class="bi bi-plus-circle"></i> Add Learning Goal
                    </button>
                </div>
            </div>
            {% endfor %}
            
            <div class="interaction-help mb-4">
                <small class="text-muted">
                    <i class="bi bi-lightbulb"></i>
                    <strong>Tips:</strong> Fields with üåê are inherited from global metadata above. 
                    Click any field to override the global value, or double-click to restore the global value.
                </small>
            </div>
            
            <div class="d-grid gap-2 col-md-6 mx-auto mt-4 mb-5">
                <button type="submit" class="btn btn-success btn-lg">
                                <i class="bi bi-cloud-upload"></i> Upload Files & Save All Documents
                </button>
                <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary">Cancel</a>
            </div>
        </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upload and Saving Overlay -->
<div class="saving-overlay" style="display: none;">
    <div class="saving-message">
        <h4 style="margin-bottom: 20px;"><strong>Uploading Files & Saving Documents</strong></h4>
        <p style="margin-bottom: 20px;"><strong>Please don't close this page!</strong></p>
        
        <!-- Overall Progress -->
        <div class="progress-phase" id="overallProgressPhase">
            <div class="progress-phase-title">Overall Progress</div>
            <div class="phase-progress">
                <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         id="overallProgressBar" role="progressbar" style="width: 0%">
                        Starting...
                    </div>
                </div>
            </div>
        </div>
        
        <!-- File Upload Phase -->
        <div class="progress-phase" id="uploadPhase">
            <div class="progress-phase-title">üì§ File Upload Progress</div>
            <div id="fileProgressList">
                <!-- Individual file progress bars will be inserted here -->
            </div>
        </div>
        
        <!-- Document Saving Phase -->
        <div class="progress-phase" id="savingPhase">
            <div class="progress-phase-title">üíæ Saving Documents</div>
            <div class="phase-progress">
                <div class="progress">
                    <div class="progress-bar" id="savingProgressBar" role="progressbar" style="width: 0%">
                        Waiting...
                    </div>
                </div>
            </div>
            <div id="savingStatus" style="margin-top: 10px; color: #fff;">
                Ready to save documents...
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.13.2/jquery-ui.min.js"></script>
<script>
    $(document).ready(function() {
    // ... existing code for global field sync, autocomplete, etc. ...
    
        function setupGlobalFieldSync() {
        $('.global-field').on('input change', function() {
                const fieldType = $(this).attr('id').replace('global_', '');
                const value = $(this).val();
                
                $(`.metadata-field[data-field-type="${fieldType}"]`).each(function() {
                    const $field = $(this);
                    const $indicator = $(`#${fieldType}_indicator_${$field.attr('id').split('_').pop()}`);
                    
                    if (!$field.hasClass('manually-edited')) {
                        $field.val(value);
                        
                        if (value) {
                            $field.addClass('inherited-from-global');
                            $indicator.addClass('active');
                        } else {
                            $field.removeClass('inherited-from-global');
                            $indicator.removeClass('active');
                        }
                    
                    if ($field.is('select')) {
                            const fieldName = $field.attr('name');
                            let hiddenInput = $(`input[name="${fieldName}_hidden"]`);
                            if (hiddenInput.length === 0) {
                                hiddenInput = $(`<input type="hidden" name="${fieldName}" value="${value}">`);
                                $field.after(hiddenInput);
                                $field.attr('name', `${fieldName}_display`);
                            } else {
                                hiddenInput.val(value);
                            }
                            $field.prop('disabled', true);
                    }
                }
            });
        });
        
        $('.metadata-field').on('focus click', function() {
            const $field = $(this);
            const fieldType = $field.data('field-type');
            const $indicator = $(`#${fieldType}_indicator_${$field.attr('id').split('_').pop()}`);
            
            if (!$field.hasClass('manually-edited')) {
                $field.removeClass('inherited-from-global');
                $field.addClass('manually-edited');
                $indicator.removeClass('active');
                
                if ($field.is('select')) {
                    $field.prop('disabled', false);
                    const hiddenInput = $(`input[name="${$field.attr('name').replace('_display', '')}_hidden"]`);
                    if (hiddenInput.length > 0) {
                        hiddenInput.remove();
                        $field.attr('name', $field.attr('name').replace('_display', ''));
                    }
                }
            }
        });
    }
        
        $('.metadata-field').on('dblclick', function() {
            const $field = $(this);
            const fieldType = $field.data('field-type');
            const $indicator = $(`#${fieldType}_indicator_${$field.attr('id').split('_').pop()}`);
            
            $field.removeClass('manually-edited');
            
            // Re-apply global value
            const globalValue = $(`#global_${fieldType}`).val();
            
            if (globalValue) {
                $field.val(globalValue);
                $field.addClass('inherited-from-global');
                $indicator.addClass('active');
                
                if ($field.is('select')) {
                    const fieldName = $field.attr('name');
                    let hiddenInput = $(`input[name="${fieldName}_hidden"]`);
                    if (hiddenInput.length === 0) {
                        hiddenInput = $(`<input type="hidden" name="${fieldName}" value="${globalValue}">`);
                        $field.after(hiddenInput);
                        $field.attr('name', `${fieldName}_display`);
                    } else {
                        hiddenInput.val(globalValue);
                    }
                    $field.prop('disabled', true);
                }
            } else {
                $field.removeClass('inherited-from-global');
                $indicator.removeClass('active');
            }
        });
        
        // Add new learning goal
        $('.add-goal-btn').click(function() {
            var index = $(this).data('index');
            var newGoal = $(`
                <div class="learning-goal-item">
                    <input type="text" class="form-control" name="learning_goals_${index}[]" required>
                    <button type="button" class="btn btn-danger btn-sm btn-remove">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `);
            $(`#learning-goals-container-${index}`).append(newGoal);
            setupAutocomplete(newGoal.find('input'));
        });
        
        // Remove learning goal
        $(document).on('click', '.btn-remove', function() {
            var container = $(this).closest('.learning-goals-container');
            var items = container.find('.learning-goal-item');
            
            if (items.length > 1) {
                $(this).closest('.learning-goal-item').remove();
            } else {
                alert('You must have at least one learning goal.');
            }
        });
        
    // Setup form submission with file upload
        $('#save-form').submit(function(e) {
            e.preventDefault();
            
            // Show saving overlay
            $('.saving-overlay').show();
            
        // Get processed files data to determine expected file count
        const processedFilesCount = $('.document-card').length;
        
        // Prepare form data
        const formData = new FormData(this);
        
        // Load files from IndexedDB and upload them
        uploadFilesFromIndexedDBAndSave(formData, processedFilesCount);
    });
    
    // IndexedDB functions (same as in index.html)
    async function openIndexedDB() {
        return new Promise((resolve, reject) => {
            if (!window.indexedDB) {
                reject(new Error('IndexedDB is not supported in this browser'));
                return;
            }
            
            const request = indexedDB.open('LearningGoalsFiles', 1);
            
            request.onerror = () => reject(request.error);
            request.onsuccess = () => resolve(request.result);
            
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains('files')) {
                    db.createObjectStore('files', { keyPath: 'id' });
                }
            };
        });
    }
    
    async function getFilesFromIndexedDB() {
        try {
            const db = await openIndexedDB();
            const transaction = db.transaction(['files'], 'readonly');
            const store = transaction.objectStore('files');
            
            return new Promise((resolve, reject) => {
                const getAllRequest = store.getAll();
                getAllRequest.onsuccess = () => {
                    const records = getAllRequest.result;
                    const files = records.map(record => {
                        // Convert ArrayBuffer back to File
                        const file = new File([record.data], record.name, {
                            type: record.type,
                            lastModified: record.lastModified
                        });
                        return {
                            index: record.id,
                            file: file
                        };
                    });
                    // Sort by index to maintain order
                    files.sort((a, b) => a.index - b.index);
                    resolve(files);
                };
                getAllRequest.onerror = () => reject(getAllRequest.error);
            });
            
        } catch (error) {
            console.error('Error retrieving files from IndexedDB:', error);
            throw new Error('Failed to retrieve files from local storage');
        }
    }
    
    async function clearFilesFromIndexedDB() {
        try {
            const db = await openIndexedDB();
            const transaction = db.transaction(['files'], 'readwrite');
            const store = transaction.objectStore('files');
            
            await new Promise((resolve, reject) => {
                const clearRequest = store.clear();
                clearRequest.onsuccess = () => resolve();
                clearRequest.onerror = () => reject(clearRequest.error);
            });
            
            console.log('Cleared all files from IndexedDB');
            
        } catch (error) {
            console.error('Error clearing files from IndexedDB:', error);
        }
    }
    
    async function uploadFilesFromIndexedDBAndSave(formData, expectedFileCount) {
        try {
            // Initialize progress phases
            updateOverallProgress(10, 'Loading files from local storage...');
            setPhaseActive('overallProgressPhase');
            
            // Load files from IndexedDB
            const filesToUpload = await getFilesFromIndexedDB();
            
            if (filesToUpload.length !== expectedFileCount) {
                throw new Error(`File count mismatch: expected ${expectedFileCount}, found ${filesToUpload.length} in local storage`);
            }
            
            console.log(`Loaded ${filesToUpload.length} files from IndexedDB for upload`);
            
            // Start file upload phase
            updateOverallProgress(20, 'Starting file uploads...');
            setPhaseActive('uploadPhase');
            
            const progressContainer = $('#fileProgressList');
            
            // Create progress bars for files
            filesToUpload.forEach((fileInfo, index) => {
                const progressHtml = `
                    <div class="upload-progress-file" id="progress-${index}">
                        <div class="file-name">${fileInfo.file.name}</div>
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" style="width: 0%">0%</div>
                        </div>
                    </div>
                `;
                progressContainer.append(progressHtml);
            });
            
            // Upload each file
            const uploadResults = [];
            const totalFiles = filesToUpload.length;
            
            for (let i = 0; i < filesToUpload.length; i++) {
                const fileInfo = filesToUpload[i];
                const progressBar = $(`#progress-${i} .progress-bar`);
                
                try {
                    const uploadProgress = 20 + ((i / totalFiles) * 60); // 20-80% for uploads
                    updateOverallProgress(uploadProgress, `Uploading files... (${i + 1} of ${totalFiles})`);
                    
                    // Generate signed URL
                    const urlResponse = await fetch('/api/generate-upload-url', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            filename: fileInfo.file.name,
                            contentType: fileInfo.file.type || 'application/pdf',
                            fileSize: fileInfo.file.size
                        })
                    });
                    
                    if (!urlResponse.ok) {
                        throw new Error(`Failed to generate upload URL for ${fileInfo.file.name}`);
                    }
                    
                    const urlData = await urlResponse.json();
                    
                    // Upload file via server proxy
                    const uploadFormData = new FormData();
                    uploadFormData.append('file', fileInfo.file);
                    uploadFormData.append('storagePath', urlData.storagePath);
                    
                    // Upload with progress tracking
                    await new Promise((resolve, reject) => {
                        const xhr = new XMLHttpRequest();
                        
                        xhr.upload.addEventListener('progress', (event) => {
                            if (event.lengthComputable) {
                                const percentComplete = Math.round((event.loaded / event.total) * 100);
                                progressBar.css('width', percentComplete + '%');
                                progressBar.text(percentComplete + '%');
                                
                                if (percentComplete === 100) {
                                    progressBar.addClass('bg-success');
                                }
                            }
                        });
                        
                        xhr.addEventListener('load', () => {
                            if (xhr.status >= 200 && xhr.status < 300) {
                                resolve();
                            } else {
                                reject(new Error(`Upload failed with status ${xhr.status}`));
                            }
                        });
                        
                        xhr.addEventListener('error', () => reject(new Error('Upload failed')));
                        
                        xhr.open('POST', '/api/upload-file');
                        xhr.send(uploadFormData);
                    });
                    
                    uploadResults.push({
                        filename: fileInfo.file.name,
                        storagePath: urlData.storagePath
                    });
                    
                } catch (error) {
                    console.error(`Error uploading ${fileInfo.file.name}:`, error);
                    progressBar.addClass('bg-danger').text('Failed');
                    throw error;
                }
            }
            
            // Complete upload phase
            setPhaseCompleted('uploadPhase');
            updateOverallProgress(80, 'All files uploaded successfully!');
            
            // Start saving phase
            setPhaseActive('savingPhase');
            updateSavingProgress(10, 'Preparing document data...');
            
            // Add upload results to form data
            formData.append('uploaded_files', JSON.stringify(uploadResults));
            
            updateSavingProgress(50, 'Saving documents to database...');
            updateOverallProgress(90, 'Saving document data...');
            
            // Submit the form with uploaded file information
            const response = await fetch('{{ url_for("main.save_document_data") }}', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Complete saving phase
                setPhaseCompleted('savingPhase');
                updateSavingProgress(100, `Successfully saved ${result.success_count} documents!`);
                updateOverallProgress(100, 'Complete!');
                
                setTimeout(() => {
                    $('.saving-message').html(`
                        <h4><strong>‚úÖ Success!</strong></h4>
                        <p style="font-size: 1.1rem; margin: 20px 0;">${result.success_count} of ${result.total} documents saved successfully!</p>
                        <p>Redirecting to home page...</p>
                    `);
                }, 1000);
                
                // Clean up stored file data
                await clearFilesFromIndexedDB();
                
                setTimeout(() => {
                    window.location.href = "{{ url_for('main.index') }}";
                }, 3000);
            } else {
                throw new Error(result.message || 'Failed to save documents');
            }
            
        } catch (error) {
            console.error('Error during upload and save:', error);
            $('.saving-overlay').hide();
            alert(`Error: ${error.message}`);
        }
    }
    
    // Helper functions for progress management
    function updateOverallProgress(percent, message) {
        $('#overallProgressBar').css('width', percent + '%').text(message);
    }
    
    function updateSavingProgress(percent, message) {
        $('#savingProgressBar').css('width', percent + '%').text(percent + '%');
        $('#savingStatus').text(message);
    }
    
    function setPhaseActive(phaseId) {
        $('.progress-phase').removeClass('active completed');
        $(`#${phaseId}`).addClass('active');
    }
    
    function setPhaseCompleted(phaseId) {
        $(`#${phaseId}`).removeClass('active').addClass('completed');
    }
        
        // Setup autocomplete for learning goals
        function setupAutocomplete(element) {
            $(element).autocomplete({
                source: function(request, response) {
                    $.ajax({
                        url: "{{ url_for('main.api_suggest') }}",
                        dataType: "json",
                    data: { q: request.term },
                    success: function(data) { response(data); }
                    });
                },
                minLength: 3
            });
        }
        
        // Setup autocomplete for existing learning goals
        $('.learning-goal-item input').each(function() {
            setupAutocomplete(this);
        });
        
        // Initialize global field synchronization
        setupGlobalFieldSync();
        
        // Setup prompt expand/collapse functionality
        $('.prompt-preview').click(function() {
            const promptDisplay = $(this).closest('.prompt-display');
            $(this).hide();
            promptDisplay.find('.prompt-full').show();
        });
        
        $('.prompt-full small').click(function() {
            const promptDisplay = $(this).closest('.prompt-display');
            $(this).closest('.prompt-full').hide();
            promptDisplay.find('.prompt-preview').show();
        });
    
    // Load session data on page load
    const sessionData = sessionStorage.getItem('processedFiles');
    if (sessionData) {
        console.log('Loaded session data:', JSON.parse(sessionData));
    }
    
    // Debug: Check if files are available in IndexedDB
    (async function checkIndexedDBFiles() {
        try {
            const files = await getFilesFromIndexedDB();
            if (files && files.length > 0) {
                console.log(`Found ${files.length} files in IndexedDB:`, files.map(f => `${f.file.name} (${f.file.size} bytes)`));
            } else {
                console.warn('No files found in IndexedDB');
            }
        } catch (error) {
            console.error('Error checking IndexedDB files:', error);
            console.warn('Files may not be available - user may need to go back and re-select files');
        }
    })();
    });
</script>
{% endblock %} 